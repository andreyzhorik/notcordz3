<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord â€” multi-channel</title>
  <style>
    /* Restored original theme & layout styling (kept compact) */
    :root{
      --bg-0: #071226;
      --bg-1: #07101a;
      --panel: #0b1220;
      --muted: #9aa4b2;
      --accent: #5865f2;
      --msg-bg: #111827;
      --me-bg: #2b3440;
      --border: rgba(255,255,255,0.06);
      --text: #e6eef6;
    }
    :root[data-theme="light"]{
      --bg-0: #f3f7fb;
      --bg-1: #eef4fb;
      --panel: #ffffff;
      --muted: #556270;
      --msg-bg: #f4f7fb;
      --me-bg: #e8eefc;
      --border: rgba(0,0,0,0.06);
      --text: #0b1220;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-0) 0%, var(--bg-1) 100%);}
    .app {
      width:100%;
      height:100vh;
      display:grid;
      grid-template-columns:260px 1fr;
      gap:0;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar{
      background:var(--panel);
      border-right:1px solid var(--border);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;color:var(--accent);font-size:18px}
    .brand .dot{width:12px;height:12px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px rgba(88,101,242,0.22)}
    .usernameBox{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .usernameBox input{
      flex:1;padding:8px;background:transparent;border:1px solid var(--border);border-radius:8px;color:inherit;outline:none;
    }
    .usernameBox button{
      padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;
    }
    .usernameLocked{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid var(--border);font-weight:600}

    .channels{margin-top:6px;display:flex;flex-direction:column;gap:6px;overflow:auto}
    .channel{
      padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer;border:1px solid transparent;
      display:flex;justify-content:space-between;align-items:center;
    }
    .channel:hover{background:rgba(255,255,255,0.01)}
    .channel.active{background:linear-gradient(90deg, rgba(88,101,242,0.12), rgba(88,101,242,0.02));color:var(--text);border-color:rgba(88,101,242,0.12)}

    .settings{margin-top:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px;border-top:1px solid var(--border)}
    .settings label{font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    .settings input[type="color"]{width:48px;height:32px;padding:0;border:none;background:transparent;cursor:pointer}
    .settings .toggleBtn{padding:8px;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer}

    /* Chat area */
    .chatPanel{display:flex;flex-direction:column;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);position:relative}
    .header{
      padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;
    }
    .header h2{margin:0;font-size:18px}
    .header .spacer{flex:1}
    .messages{
      flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;
      /* ensure we can scroll */
      min-height: 0;
    }
    .message{display:flex;gap:12px;align-items:flex-start;max-width:85%;}
    .message.me{margin-left:auto;justify-content:flex-end;}
    .bubble{background:var(--msg-bg);padding:10px 12px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:6px;color:#dbe8ff;word-break:break-word}
    .message.me .bubble{background:var(--me-bg)}
    .meta{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .meta .name{font-weight:700}
    .meta .time{font-size:12px;color:var(--muted)}
    .text{white-space:pre-wrap;color:inherit;font-size:15px;word-break:break-word;overflow-wrap:break-word}

    .inputArea{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .inputArea textarea{flex:1;min-height:44px;max-height:160px;resize:none;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:inherit;outline:none}
    .controls{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:120px}
    .charCount{font-size:12px;color:var(--muted)}
    .sendBtn{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .sendBtn:disabled{opacity:0.6;cursor:default}

    .replyPreview{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin:12px 16px;color:var(--muted);display:none}

    @media (max-width:860px){
      .app{grid-template-columns:200px 1fr}
      .sidebar{padding:10px}
    }
    @media (max-width:720px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand"><div class="dot"></div>notcord</div>

      <div id="usernameSection">
        <div class="usernameBox" id="usernameBox">
          <input type="text" id="usernameInput" placeholder="Choose username (once)" maxlength="40" />
          <button id="setNameBtn">Set</button>
        </div>
        <div class="usernameLocked" id="usernameLocked" style="display:none">
          <div id="usernameDisplay"></div>
        </div>
      </div>

      <div style="height:6px"></div>

      <div class="channels" id="channels">
        <div class="channel active" data-id="general" role="button"># general</div>
        <div class="channel" data-id="general-2" role="button"># general 2</div>
        <div class="channel" data-id="photos" role="button"># photos</div>
      </div>

      <div class="settings" aria-label="Appearance settings">
        <label>
          Your name color
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="nameColor" title="Name color" />
            <div style="flex:1"></div>
            <button id="resetNameColor" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>
          Accent color
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="accentColor" title="Accent color" />
            <div style="flex:1"></div>
            <button id="resetAccent" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>
          Theme
          <div style="display:flex;gap:8px;align-items:center">
            <button id="themeToggle" class="toggleBtn">Toggle light/dark</button>
            <div style="flex:1"></div>
            <button id="resetTheme" class="toggleBtn">Reset</button>
          </div>
        </label>

        <div style="font-size:12px;color:var(--muted);padding-top:6px">Username and appearance are saved in this browser.</div>
      </div>
    </aside>

    <section class="chatPanel">
      <div class="header">
        <h2 id="channelTitle"># general</h2>
        <div class="spacer"></div>
        <div id="status" style="color:var(--muted);font-size:13px">Connecting...</div>
      </div>

      <div class="replyPreview" id="replyPreview">Replying to <span id="replyToName"></span>: <span id="replyToText"></span> <button id="cancelReply" style="margin-left:8px;background:transparent;border:1px solid var(--border);color:var(--muted);padding:4px 6px;border-radius:6px;cursor:pointer">Cancel</button></div>

      <div class="messages" id="messages" role="log" aria-atomic="false"></div>

      <div class="inputArea" id="inputArea" style="display:none">
        <textarea id="messageInput" placeholder="Message (Shift+Enter for newline)" maxlength="100"></textarea>
        <div class="controls">
          <div class="charCount" id="charCount">0 / 100</div>
          <button id="sendBtn" class="sendBtn" disabled>Send</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    (function(){
      // Channel endpoints
      const CHANNELS = {
        general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat',
        'general-2': 'https://68eeed86b06cc802829ba196.mockapi.io/chat2',
        photos:  'https://68eeed86b06cc802829ba196.mockapi.io/photos'
      };

      // DOM
      const rootEl = document.documentElement;
      const channelsEl = document.getElementById('channels');
      const channelTitleEl = document.getElementById('channelTitle');
      const messagesEl = document.getElementById('messages');
      const statusEl = document.getElementById('status');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const charCountEl = document.getElementById('charCount');
      const inputArea = document.getElementById('inputArea');

      const usernameBox = document.getElementById('usernameBox');
      const usernameInput = document.getElementById('usernameInput');
      const setNameBtn = document.getElementById('setNameBtn');
      const usernameLocked = document.getElementById('usernameLocked');
      const usernameDisplay = document.getElementById('usernameDisplay');

      const nameColorInput = document.getElementById('nameColor');
      const accentColorInput = document.getElementById('accentColor');
      const resetNameColorBtn = document.getElementById('resetNameColor');
      const resetAccentBtn = document.getElementById('resetAccent');
      const themeToggleBtn = document.getElementById('themeToggle');
      const resetThemeBtn = document.getElementById('resetTheme');

      const replyPreview = document.getElementById('replyPreview');
      const replyToName = document.getElementById('replyToName');
      const replyToText = document.getElementById('replyToText');
      const cancelReplyBtn = document.getElementById('cancelReply');

      // state
      let activeChannel = localStorage.getItem('notcord_channel') || 'general';
      let apiBase = CHANNELS[activeChannel];
      let polling = null;
      let isSending = false;
      let allowUnload = false; // only allow closing when set true by backslash

      // user settings
      let username = localStorage.getItem('notcord_username') || '';
      let nameColor = localStorage.getItem('notcord_nameColor') || '#ffcc00';
      let accentColor = localStorage.getItem('notcord_accent') || '#5865f2';
      let theme = localStorage.getItem('notcord_theme') || 'dark'; // 'dark' or 'light'
      const MAX_CHARS = 100;

      // reply state
      let currentReply = null; // { username, message }

      // initial UI state
      function applyTheme(){
        rootEl.setAttribute('data-theme', theme);
        document.documentElement.style.setProperty('--accent', accentColor);
      }

      function initializeAppearanceInputs(){
        nameColorInput.value = nameColor;
        accentColorInput.value = accentColor;
      }

      function setStatus(txt){
        statusEl.textContent = txt;
      }

      function renderMessage(msg, isMe=false){
        const container = document.createElement('div');
        container.className = 'message' + (isMe ? ' me' : '');

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('span');
        name.className = 'name';
        const author = msg.username || msg.name || msg.author || 'Unknown';
        name.textContent = author;
        if(msg.nameColor) name.style.color = msg.nameColor;
        else if(author === username && nameColor) name.style.color = nameColor;

        const time = document.createElement('span');
        time.className = 'time';
        const created = msg.createdAt || msg.created_at || msg.timestamp || msg.time || '';
        time.textContent = formatTime(created);

        meta.appendChild(name);
        meta.appendChild(time);

        // reply preview if present
        if(msg.replyTo && typeof msg.replyTo === 'object'){
          const rp = document.createElement('div');
          rp.style.fontSize = '13px';
          rp.style.color = 'var(--muted)';
          rp.style.padding = '6px';
          rp.style.borderRadius = '8px';
          rp.style.background = 'rgba(255,255,255,0.02)';
          rp.style.marginBottom = '6px';
          rp.textContent = (msg.replyTo.username || 'unknown') + ': ' + ((msg.replyTo.message||'').slice(0,120));
          bubble.appendChild(rp);
        }

        const text = document.createElement('div');
        text.className = 'text';
        text.textContent = msg.message || msg.text || msg.content || '';

        bubble.appendChild(meta);
        bubble.appendChild(text);

        // reply action
        const actions = document.createElement('div');
        actions.style.marginTop = '6px';
        const replyBtn = document.createElement('button');
        replyBtn.textContent = 'Reply';
        replyBtn.style.background = 'transparent';
        replyBtn.style.border = '1px solid var(--border)';
        replyBtn.style.color = 'var(--muted)';
        replyBtn.style.padding = '6px 8px';
        replyBtn.style.borderRadius = '8px';
        replyBtn.style.cursor = 'pointer';
        replyBtn.addEventListener('click', () => {
          startReply(msg);
        });
        actions.appendChild(replyBtn);
        bubble.appendChild(actions);

        container.appendChild(bubble);
        return container;
      }

      function formatTime(iso){
        try{
          const d = new Date(iso);
          if(isNaN(d)) return '';
          return d.toLocaleString([], { hour: '2-digit', minute: '2-digit' });
        }catch(e){ return ''; }
      }

      function scrollToBottom(){
        requestAnimationFrame(()=> messagesEl.scrollTop = messagesEl.scrollHeight);
      }

      // Fetch messages for current channel
      async function fetchMessages(){
        if(!apiBase) return;
        try{
          const res = await fetch(apiBase);
          if(!res.ok) throw new Error('Fetch failed: ' + res.status);
          const data = await res.json();
          if(!Array.isArray(data)) return;
          data.sort((a,b)=>{
            const ta = new Date(a.createdAt||a.created_at||a.timestamp||0).getTime() || (Number(a.id)||0);
            const tb = new Date(b.createdAt||b.created_at||b.timestamp||0).getTime() || (Number(b.id)||0);
            return ta - tb;
          });
          messagesEl.innerHTML = '';
          for(const msg of data){
            const isMe = ( (msg.username || msg.name || msg.author) === username );
            const el = renderMessage(msg, isMe);
            messagesEl.appendChild(el);
          }
          scrollToBottom();
          setStatus('Connected â€” ' + data.length + ' messages');
        }catch(err){
          console.error(err);
          setStatus('Error fetching messages');
        }
      }

      // Post with optimistic UI and include reply payload if set
      async function postMessage(text){
        if(!text || !text.trim()) return;
        if(!username){ setStatus('Set username first'); return; }
        if(!apiBase){ setStatus('No channel selected'); return; }
        if(isSending) return;
        isSending = true;
        sendBtn.disabled = true;

        const payload = {
          username: username,
          message: text.trim(),
          createdAt: new Date().toISOString()
        };
        if(currentReply) payload.replyTo = { username: currentReply.username, message: currentReply.message };

        const optimisticEl = renderMessage(payload, true);
        messagesEl.appendChild(optimisticEl);
        scrollToBottom();

        try{
          const res = await fetch(apiBase, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw new Error('Send failed: ' + res.status);
          // reconcile by refetching
          await fetchMessages();
        }catch(err){
          console.error(err);
          setStatus('Failed to send message');
        }finally{
          isSending = false;
          sendBtn.disabled = false;
          // clear reply
          currentReply = null;
          replyPreview.style.display = 'none';
        }
      }

      // Channel switching
      function setActiveChannel(id){
        activeChannel = id;
        apiBase = CHANNELS[id];
        localStorage.setItem('notcord_channel', id);
        // UI active state
        Array.from(channelsEl.children).forEach(ch => ch.classList.toggle('active', ch.dataset.id === id));
        channelTitleEl.textContent = '# ' + id;
        // restart polling for new channel
        if(polling) clearInterval(polling);
        fetchMessages();
        polling = setInterval(fetchMessages, 4000);
      }

      // Reply flow
      function startReply(msg){
        currentReply = { username: msg.username || msg.name || 'Unknown', message: msg.message || msg.text || msg.content || '' };
        replyToName.textContent = currentReply.username;
        replyToText.textContent = currentReply.message.length > 120 ? (currentReply.message.slice(0,120) + '...') : currentReply.message;
        replyPreview.style.display = 'block';
        // ensure input visible
        inputArea.style.display = 'flex';
        messageInput.focus();
      }
      cancelReplyBtn.addEventListener('click', ()=> {
        currentReply = null;
        replyPreview.style.display = 'none';
      });

      // Input and controls
      function updateCharCountAndState(){
        let val = messageInput.value || '';
        if(val.length > MAX_CHARS){
          messageInput.value = messageInput.value.slice(0, MAX_CHARS);
          val = messageInput.value;
        }
        charCountEl.textContent = `${val.length} / ${MAX_CHARS}`;
        const canSend = username && val.trim().length > 0;
        sendBtn.disabled = !canSend || isSending;
      }

      channelsEl.addEventListener('click', (e)=>{
        const ch = e.target.closest('.channel');
        if(!ch) return;
        setActiveChannel(ch.dataset.id);
      });

      setNameBtn.addEventListener('click', ()=>{
        let val = usernameInput.value.trim();
        if(!val) {
          val = 'Guest' + Math.floor(Math.random()*9000 + 1000);
        }
        username = val;
        localStorage.setItem('notcord_username', username);
        usernameBox.style.display = 'none';
        usernameLocked.style.display = 'flex';
        usernameDisplay.textContent = username;
        setStatus('Username set: ' + username);
        updateCharCountAndState();
      });

      sendBtn.addEventListener('click', ()=>{
        const txt = messageInput.value;
        if(!txt.trim()) return;
        postMessage(txt);
        messageInput.value = '';
        updateCharCountAndState();
      });

      messageInput.addEventListener('input', (e)=>{
        if(messageInput.value.length > MAX_CHARS){
          messageInput.value = messageInput.value.slice(0, MAX_CHARS);
        }
        updateCharCountAndState();
      });

      messageInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          if(!sendBtn.disabled) sendBtn.click();
        }
      });

      // appearance inputs
      nameColorInput.addEventListener('input', (e)=> {
        nameColor = e.target.value;
        localStorage.setItem('notcord_nameColor', nameColor);
        Array.from(messagesEl.querySelectorAll('.meta .name')).forEach(el=>{
          if(el.textContent === username) el.style.color = nameColor;
        });
      });
      resetNameColorBtn.addEventListener('click', ()=>{
        nameColor = '#ffcc00';
        nameColorInput.value = nameColor;
        localStorage.setItem('notcord_nameColor', nameColor);
        Array.from(messagesEl.querySelectorAll('.meta .name')).forEach(el=>{
          if(el.textContent === username) el.style.color = nameColor;
        });
      });

      accentColorInput.addEventListener('input', (e)=> {
        accentColor = e.target.value;
        localStorage.setItem('notcord_accent', accentColor);
        document.documentElement.style.setProperty('--accent', accentColor);
      });
      resetAccentBtn.addEventListener('click', ()=>{
        accentColor = '#5865f2';
        accentColorInput.value = accentColor;
        localStorage.setItem('notcord_accent', accentColor);
        document.documentElement.style.setProperty('--accent', accentColor);
      });

      themeToggleBtn.addEventListener('click', ()=> {
        theme = (theme === 'dark') ? 'light' : 'dark';
        localStorage.setItem('notcord_theme', theme);
        applyTheme();
      });
      resetThemeBtn.addEventListener('click', ()=> {
        theme = 'dark';
        localStorage.setItem('notcord_theme', theme);
        applyTheme();
      });

      // Initialization
      function init(){
        applyTheme();
        initializeAppearanceInputs();

        if(username){
          usernameBox.style.display = 'none';
          usernameLocked.style.display = 'flex';
          usernameDisplay.textContent = username;
        } else {
          usernameBox.style.display = 'flex';
          usernameLocked.style.display = 'none';
        }

        setActiveChannel(activeChannel);
        updateCharCountAndState();

        setStatus('Connected (polling every 4s)');
      }

      init();

      // Prevent navigation to other sites (basic client-side)
      // Block anchor clicks
      document.addEventListener('click', function(e){
        const a = e.target.closest('a');
        if(a){
          e.preventDefault();
          alert('Navigation blocked in this client.');
        }
      }, true);
      // Override window.open
      window.open = function(){ alert('Popup blocked in this client.'); return null; };

      // Before unload handler - block closing unless allowUnload is true
      function beforeUnloadHandler(e){
        if(allowUnload) return;
        // Standard message won't be shown in many browsers, but returning a value and calling preventDefault will trigger the confirmation dialog.
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
      window.addEventListener('beforeunload', beforeUnloadHandler);

      // Only allow closing when user presses backslash "\" key.
      // Pressing "\" will set allowUnload = true and then attempt to close window.
      window.addEventListener('keydown', function(e){
        // On many layouts, '|' is shift+backslash; we only allow backslash per request.
        if(e.key === '\\'){
          // allow close
          allowUnload = true;
          // Remove beforeunload handler to avoid further blocks
          try{ window.removeEventListener('beforeunload', beforeUnloadHandler); }catch(err){}
          // Attempt to close the window programmatically.
          // Note: window.close() will only close windows opened by script in many browsers.
          // To help the user, show a message and instruct them to close the tab if window.close() is blocked.
          const closed = window.close && window.close();
          // If window.close did not work, inform the user the page can now be closed.
          setTimeout(()=> {
            if(!closed) alert('Close enabled. You may now close the tab or window.');
          }, 200);
        }
      });

      // Also prevent changes via location.assign/replace from other scripts
      if(window.location){
        try{
          const origAssign = window.location.assign;
          window.location.assign = function(){ alert('Navigation blocked in this client. Use \\ to enable closing.'); };
          const origReplace = window.location.replace;
          window.location.replace = function(){ alert('Navigation blocked in this client. Use \\ to enable closing.'); };
        }catch(e){}
      }

      // Cleanup on unload - ensure polling cleared
      window.addEventListener('unload', ()=> { if(polling) clearInterval(polling); });

    })();
  </script>
</body>
</html>
