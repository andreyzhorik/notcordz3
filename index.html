<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord — refreshed UI</title>
  <style>
    :root{
      --bg-a: #071226;   /* theme 1 */
      --bg-b: #07101a;   /* theme 2 */
      --accent: #5865f2;
      --muted: #9aa4b2;
      --card: #0b2233;
      --text: #e6eef6;
      --me-bg: #22303a;
      --pin-bg: rgba(88,101,242,0.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Helvetica,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg-a),var(--bg-b));-webkit-font-smoothing:antialiased}
    /* New layout: left compact server / center chat / right members collapsed section */
    .app{height:100vh;display:grid;grid-template-columns:80px 1fr 280px;gap:12px;padding:12px;align-items:stretch}
    /* server column */
    .servers{background:rgba(255,255,255,0.02);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:10px;align-items:center;border:1px solid rgba(255,255,255,0.04)}
    .serverBtn{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;background:transparent;border:1px solid transparent;color:var(--text);cursor:pointer}
    .serverBtn.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.04)}
    /* main chat card */
    .chatCard{border-radius:12px;padding:0;display:flex;flex-direction:column;overflow:hidden;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .chatHeader{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}
    .chatHeader .title{font-weight:800;font-size:18px}
    .chatHeader .subtitle{color:var(--muted);font-size:13px}
    .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px;min-height:0}
    .messageRow{display:flex;gap:12px;align-items:flex-start}
    .messageRow.me{flex-direction:row-reverse}
    .avatar{width:44px;height:44px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--text);overflow:hidden;flex-shrink:0}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{max-width:78%;padding:10px 12px;border-radius:12px;background:var(--card);box-shadow:0 6px 18px rgba(2,6,23,0.45);color:var(--text);display:flex;flex-direction:column;gap:8px}
    .messageRow.me .bubble{background:var(--me-bg)}
    .meta{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .meta .name{font-weight:700}
    .controls{display:flex;gap:6px;margin-left:auto}
    .smallBtn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .pinnedBar{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;background:linear-gradient(180deg, rgba(88,101,242,0.03), transparent)}
    .pinChip{background:var(--pin-bg);padding:6px 10px;border-radius:10px;font-size:13px;color:var(--text);display:flex;gap:8px;align-items:center}
    .inputArea{padding:12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:flex-end;background:linear-gradient(180deg, transparent, rgba(0,0,0,0.02))}
    .textInput{flex:1;min-height:56px;max-height:320px;padding:12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text);outline:none;resize:none}
    .sendBtn{background:var(--accent);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    .sendBtn:disabled{opacity:0.6;cursor:default}
    .toolbar{display:flex;gap:8px;align-items:center}
    /* right panel */
    .rightPanel{border-radius:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:12px}
    .sectionTitle{font-size:13px;color:var(--muted);font-weight:700}
    .player{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.01)}
    .player .dot{width:10px;height:10px;border-radius:50%;background:#39d353;box-shadow:0 0 8px rgba(57,211,83,0.08)}
    .themes{display:flex;gap:8px;align-items:center}
    .themeBtn{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;color:var(--muted);background:transparent}
    /* emoji picker */
    .emojiPicker{position:absolute;z-index:60;background:rgba(0,0,0,0.8);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);display:grid;grid-template-columns:repeat(8,28px);gap:6px}
    .emojiItem{cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
    /* photos */
    .photoMessage img{max-width:100%;height:auto;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.45);cursor:pointer}
    /* responsive */
    @media (max-width:980px){ .app{grid-template-columns:64px 1fr 200px} .rightPanel{display:none} }
    @media (max-width:720px){ .app{grid-template-columns:64px 1fr} .rightPanel{display:none} }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="servers" aria-label="servers">
      <button class="serverBtn active" title="notcord">N</button>
      <button class="serverBtn" title="photos">P</button>
      <button class="serverBtn" title="settings">S</button>
    </div>

    <main class="chatCard" id="chatCard">
      <div class="chatHeader">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="width:48px;height:48px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:900">N</div>
          <div>
            <div class="title" id="channelTitle"># general</div>
            <div class="subtitle" id="channelSubtitle">Welcome to notcord — use @name to mention</div>
          </div>
        </div>
        <div style="flex:1"></div>
        <div style="display:flex;align-items:center;gap:8px">
          <div id="status" style="color:var(--muted);font-size:13px">Connecting...</div>
        </div>
      </div>

      <div id="pinnedBar" class="pinnedBar" style="display:none">
        <div style="font-size:13px;color:var(--muted)">Pinned</div>
        <div id="pinnedList" style="display:flex;gap:8px;overflow:auto"></div>
      </div>

      <div id="messages" class="messages" role="log" aria-live="polite"></div>

      <div class="inputArea" id="inputArea">
        <textarea id="messageInput" class="textInput" placeholder="Message (Shift+Enter for newline)" maxlength="200"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
          <div class="toolbar">
            <button id="emojiBtn" class="smallBtn" title="Emoji">😊</button>
            <button id="attachBtn" class="smallBtn" title="Attach photo">📎</button>
            <input id="photoInput" type="file" accept="image/*,image/gif" style="display:none">
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div style="font-size:12px;color:var(--muted)" id="charCount">0 / 200</div>
            <button id="sendBtn" class="sendBtn" disabled>Send</button>
          </div>
        </div>
      </div>
    </main>

    <aside class="rightPanel" id="rightPanel">
      <div>
        <div class="sectionTitle">Appearance</div>
        <div style="margin-top:8px" class="themes">
          <button class="themeBtn" data-theme="1">Theme 1</button>
          <button class="themeBtn" data-theme="2">Theme 2</button>
          <button class="themeBtn" data-theme="3">Theme 3</button>
        </div>
      </div>

      <div>
        <div class="sectionTitle">Profile</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div id="userAvatar" class="avatar">G</div>
          <div style="flex:1">
            <input id="usernameInput" placeholder="username (max 8)" maxlength="8" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)" />
            <div style="margin-top:6px;display:flex;gap:6px">
              <button id="setNameBtn" class="smallBtn">Set</button>
              <input id="nameColor" type="color" title="Name color" style="width:40px;height:32px;padding:0;border-radius:6px;border:none;background:transparent"/>
            </div>
          </div>
        </div>
        <div style="margin-top:8px">
          <label style="font-size:12px;color:var(--muted)">Avatar (change once/week)</label>
          <div style="display:flex;gap:6px;margin-top:6px">
            <input id="avatarInput" type="file" accept="image/*" />
            <button id="changeAvatarBtn" class="smallBtn">Upload</button>
          </div>
        </div>
      </div>

      <div>
        <div class="sectionTitle">Players</div>
        <div id="playersList" style="margin-top:8px;display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </aside>
  </div>

  <script>
    (function(){
      // Simplified endpoints (mockapi used previously)
      const CHANNELS = { general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat', photos: 'https://68eeed86b06cc802829ba196.mockapi.io/photos' };
      const PLAYERS_API = 'https://68e839b2f2707e6128ca35e1.mockapi.io/players';

      // DOM refs
      const messagesEl = document.getElementById('messages');
      const statusEl = document.getElementById('status');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const charCountEl = document.getElementById('charCount');
      const emojiBtn = document.getElementById('emojiBtn');
      const attachBtn = document.getElementById('attachBtn');
      const photoInput = document.getElementById('photoInput');
      const pinnedBar = document.getElementById('pinnedBar');
      const pinnedList = document.getElementById('pinnedList');

      const usernameInput = document.getElementById('usernameInput');
      const setNameBtn = document.getElementById('setNameBtn');
      const nameColorInput = document.getElementById('nameColor');
      const avatarInput = document.getElementById('avatarInput');
      const changeAvatarBtn = document.getElementById('changeAvatarBtn');
      const userAvatarEl = document.getElementById('userAvatar');

      const themeButtons = document.querySelectorAll('.themeBtn');

      // state
      let username = localStorage.getItem('notcord_username') || '';
      let nameColor = localStorage.getItem('notcord_nameColor') || '#ffcc00';
      let avatarDataUrl = localStorage.getItem('notcord_avatar') || null;
      let nameChangedAt = Number(localStorage.getItem('notcord_name_changed') || 0);
      let avatarChangedAt = Number(localStorage.getItem('notcord_avatar_changed') || 0);
      let pinned = JSON.parse(localStorage.getItem('notcord_pins') || '[]');
      let activeChannel = 'general';
      let apiBase = CHANNELS[activeChannel];
      let polling = null;
      const MAX_CHARS = 200;
      const ONE_WEEK_MS = 7*24*60*60*1000;

      // emoji picker
      const EMOJIS = ['😀','😁','😂','🤣','😊','😍','😎','😉','👍','🙏','🔥','🎉','💯','🧡','🤝','✨','🤔','😅','😢','😡','👏','🙌','🤩','😴','😜','🙃','😇','😬','🤖','🌟','🍕','☕'];
      let emojiPickerEl = null;

      // basic bad words
      const BAD_WORDS = ['fuck','bitch','nigger','нахуй','гей','gay','хуета'];

      // css themes definitions
      const THEMES = {
        1: { bgA:'#071226', bgB:'#07101a', card:'#0b2233', accent:'#5865f2' },
        2: { bgA:'#00111a', bgB:'#001822', card:'#082233', accent:'#3ba55d' },
        3: { bgA:'#1c0b1e', bgB:'#301124', card:'#2b1030', accent:'#ff7b00' }
      };

      /* utility */
      function setStatus(txt){ statusEl.textContent = txt; }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function formatTime(iso){ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){return ''} }
      function savePins(){ localStorage.setItem('notcord_pins', JSON.stringify(pinned)); renderPinned(); }
      function containsBadWords(text){
        if(!text) return false;
        const lower = text.toLowerCase();
        return BAD_WORDS.some(w => w && lower.includes(w));
      }

      /* theme application */
      function applyTheme(num){
        const t = THEMES[num] || THEMES[1];
        document.documentElement.style.setProperty('--bg-a', t.bgA);
        document.documentElement.style.setProperty('--bg-b', t.bgB);
        document.documentElement.style.setProperty('--card', t.card);
        document.documentElement.style.setProperty('--accent', t.accent);
        localStorage.setItem('notcord_theme', String(num));
      }

      /* pinned rendering */
      function renderPinned(){
        pinnedList.innerHTML = '';
        if(!pinned.length){ pinnedBar.style.display = 'none'; return; }
        pinnedBar.style.display = 'flex';
        pinned.forEach((p,i)=>{
          const chip = document.createElement('div'); chip.className='pinChip';
          chip.textContent = (p.username? p.username+': ':'') + ((p.message||p.text||'').slice(0,40)) + ((p.message||'').length>40? '…':'');
          const unpin = document.createElement('button'); unpin.className='smallBtn'; unpin.textContent='Unpin';
          unpin.onclick = ()=>{ pinned.splice(i,1); savePins(); };
          chip.appendChild(unpin);
          pinnedList.appendChild(chip);
        });
      }

      /* rendering messages */
      function renderMessage(msg){
        if(msg.privateTo && !(msg.privateTo === username || msg.username === username)) return null;
        const row = document.createElement('div'); row.className='messageRow' + ((msg.username||'')===username ? ' me' : '');

        const avatar = document.createElement('div'); avatar.className='avatar';
        if(msg.avatar) { const im=document.createElement('img'); im.src=msg.avatar; avatar.appendChild(im); }
        else avatar.textContent = (msg.username||'U').slice(0,1).toUpperCase();

        const bubble = document.createElement('div'); bubble.className='bubble';
        const meta = document.createElement('div'); meta.className='meta';
        const nameEl = document.createElement('div'); nameEl.className='name'; nameEl.textContent = msg.username || 'Unknown';
        if(msg.nameColor) nameEl.style.color = msg.nameColor;
        const timeEl = document.createElement('div'); timeEl.className='time'; timeEl.style.marginLeft='8px'; timeEl.style.fontSize='12px'; timeEl.style.color='var(--muted)'; timeEl.textContent = formatTime(msg.createdAt || msg.created_at || msg.timestamp || new Date().toISOString());
        meta.appendChild(nameEl); meta.appendChild(timeEl);

        const controls = document.createElement('div'); controls.className='controls';
        const replyBtn = document.createElement('button'); replyBtn.className='smallBtn'; replyBtn.textContent='Reply';
        replyBtn.onclick = ()=> setReplyTo(msg);
        const pinBtn = document.createElement('button'); pinBtn.className='smallBtn'; pinBtn.textContent='Pin';
        pinBtn.onclick = ()=> { pinned.unshift({ username: msg.username, message: msg.message || msg.text || '', createdAt: msg.createdAt || msg.created_at }); pinned = pinned.slice(0,10); savePins(); };
        controls.appendChild(replyBtn); controls.appendChild(pinBtn);
        meta.appendChild(controls);

        bubble.appendChild(meta);

        if(msg.replyTo){
          const rt = document.createElement('div'); rt.style.fontSize='12px'; rt.style.color='var(--muted)'; rt.style.borderLeft='3px solid rgba(255,255,255,0.03)'; rt.style.paddingLeft='8px';
          rt.textContent = `Reply to ${(msg.replyTo.name || msg.replyTo.username || '')}: ${ (msg.replyTo.message || msg.replyTo.text || '').slice(0,120) }`;
          bubble.appendChild(rt);
        }

        if(msg.imageUrl){
          const photoWrap = document.createElement('div'); photoWrap.className='photoMessage';
          const img = document.createElement('img'); img.src = msg.imageUrl; img.alt = msg.message || '';
          img.addEventListener('click', ()=> window.open(img.src, '_blank'));
          photoWrap.appendChild(img);
          if(msg.message){
            const cap = document.createElement('div'); cap.className='text'; cap.textContent = msg.message;
            photoWrap.appendChild(cap);
          }
          bubble.appendChild(photoWrap);
        } else {
          const text = document.createElement('div'); text.className='text';
          let content = msg.message || msg.text || '';
          // highlight mentions
          content = escapeHtml(content).replace(/@([A-Za-z0-9_]{1,8})/g, (m,p1) => `<span style="color:var(--accent);font-weight:700">@${p1}</span>`);
          text.innerHTML = content;
          bubble.appendChild(text);
        }

        row.appendChild(avatar); row.appendChild(bubble);
        return row;
      }

      function isAtBottom(){ return messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 120; }
      function scrollToBottom(){ requestAnimationFrame(()=> messagesEl.scrollTop = messagesEl.scrollHeight); }

      /* fetch messages (polling) */
      async function fetchMessages(){
        if(!apiBase) return;
        try{
          const res = await fetch(apiBase);
          if(!res.ok) throw new Error('Fetch failed');
          let data = await res.json();
          if(!Array.isArray(data)) data = [];
          data.sort((a,b)=> (new Date(a.createdAt||a.created_at||a.timestamp||0).getTime() || 0) - (new Date(b.createdAt||b.created_at||b.timestamp||0).getTime() || 0));
          const wasBottom = isAtBottom();
          messagesEl.innerHTML = '';
          for(const m of data){
            const el = renderMessage(m);
            if(el) messagesEl.appendChild(el);
          }
          if(wasBottom) scrollToBottom();
          setStatus('Connected — ' + data.length + ' messages');
        }catch(e){ console.warn(e); setStatus('Error fetching'); }
      }

      /* posting */
      async function postMessage(rawText){
        if(!rawText || !rawText.trim()) return;
        if(!username){ setStatus('Set username first'); return; }
        if(containsBadWords(rawText)){ setStatus('Forbidden words detected. Message blocked.'); return; }

        let privateTo = null;
        let messageText = rawText.trim();
        if(messageText.toLowerCase().startsWith('/w ')){
          const m = messageText.match(/^\/w\s+(\S+)\s+([\s\S]+)$/i);
          if(m){ privateTo = m[1]; messageText = m[2]; } else { setStatus('Whisper format: /w name text'); return; }
        }

        const payload = { username, message: messageText, createdAt: new Date().toISOString(), nameColor, privateTo: privateTo || null, avatar: avatarDataUrl || null };
        // optimistic render
        const optimistic = renderMessage(payload);
        if(optimistic) messagesEl.appendChild(optimistic);
        scrollToBottom();

        try{
          const r = await fetch(apiBase, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!r.ok) throw new Error('Send failed');
          await fetchMessages();
        }catch(e){ console.warn(e); setStatus('Failed to send'); }
      }

      /* upload photo: user requested big photos allowed (we will NOT downscale unless >4MB to avoid browser crashes) */
      async function uploadPhotoFile(file){
        if(!file) return;
        if(containsBadWords(file.name)){ setStatus('Forbidden file name'); return; }
        try{
          setStatus('Preparing photo...');
          const dataUrl = await new Promise((res,rej)=>{
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.onerror = () => rej('read fail');
            r.readAsDataURL(file);
          });
          // If overly large (>4MB) downscale to avoid huge payloads (best-effort)
          let finalData = dataUrl;
          if(finalData.length > 4 * 1024 * 1024){
            // try to downscale to 1920x1920
            const img = new Image();
            const p = new Promise((resolve, reject)=>{
              img.onload = ()=>{
                const w = img.width, h = img.height;
                const ratio = Math.min(1920/w, 1920/h, 1);
                const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
                const canvas = document.createElement('canvas'); canvas.width = cw; canvas.height = ch;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img,0,0,cw,ch);
                resolve(canvas.toDataURL('image/jpeg', 0.9));
              };
              img.onerror = ()=> reject('image load fail');
              img.src = dataUrl;
            });
            finalData = await p;
          }

          const payload = { username, createdAt: new Date().toISOString(), nameColor, imageUrl: finalData, message: '', avatar: avatarDataUrl || null };
          const r = await fetch(CHANNELS.photos, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!r.ok) throw new Error('upload failed');
          setStatus('Photo uploaded');
          await fetchMessages();
        }catch(e){ console.warn(e); setStatus('Photo upload failed'); }
      }

      /* reply handling */
      let replyTo = null;
      const replyPreview = document.createElement('div');
      replyPreview.style.display='none';
      replyPreview.style.padding='8px';
      replyPreview.style.background='rgba(255,255,255,0.02)';
      replyPreview.style.borderRadius='8px';
      replyPreview.style.margin='8px 16px';
      document.querySelector('.chatCard').insertBefore(replyPreview, document.querySelector('#messages'));

      function setReplyTo(msg){
        replyTo = msg;
        replyPreview.style.display='block';
        replyPreview.innerHTML = `<strong>${escapeHtml(msg.username || msg.name || 'Unknown')}</strong> — ${(escapeHtml((msg.message||msg.text||'')).slice(0,140))} <button id="cancelReply" class="smallBtn">Esc</button>`;
        document.getElementById('cancelReply').onclick = clearReply;
        messageInput.focus();
      }
      function clearReply(){
        replyTo = null;
        replyPreview.style.display='none';
        replyPreview.innerHTML = '';
      }

      /* event wiring */
      messageInput.addEventListener('input', ()=>{
        const v = messageInput.value || '';
        if(v.length > MAX_CHARS) messageInput.value = v.slice(0, MAX_CHARS);
        charCountEl.textContent = `${messageInput.value.length} / ${MAX_CHARS}`;
        const can = (messageInput.value||'').trim().length > 0 && username;
        sendBtn.disabled = !can;
      });

      messageInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
        if(e.key === 'Escape' && replyTo){ clearReply(); }
      });

      sendBtn.addEventListener('click', ()=>{
        const txt = messageInput.value;
        if(replyTo){
          // attach reply metadata
          const metaText = txt + ' ';
          postMessage(metaText); // server-side reply included not implemented fully on mock; kept simple
          clearReply();
        } else {
          postMessage(txt);
        }
        messageInput.value = ''; messageInput.dispatchEvent(new Event('input'));
      });

      attachBtn.addEventListener('click', ()=> photoInput.click());
      photoInput.addEventListener('change', ()=> {
        if(photoInput.files && photoInput.files[0]) uploadPhotoFile(photoInput.files[0]);
        photoInput.value = '';
      });

      /* emoji picker */
      function showEmojiPicker(){
        if(emojiPickerEl){
          emojiPickerEl.remove(); emojiPickerEl = null; return;
        }
        emojiPickerEl = document.createElement('div'); emojiPickerEl.className='emojiPicker';
        EMOJIS.forEach(e => {
          const it = document.createElement('div'); it.className='emojiItem'; it.textContent = e;
          it.onclick = ()=> { insertAtCursor(messageInput, e); emojiPickerEl.remove(); emojiPickerEl = null; messageInput.focus(); messageInput.dispatchEvent(new Event('input')); };
          emojiPickerEl.appendChild(it);
        });
        // position near button
        const rect = emojiBtn.getBoundingClientRect();
        emojiPickerEl.style.top = (rect.bottom + window.scrollY + 6) + 'px';
        emojiPickerEl.style.left = (rect.left + window.scrollX - 10) + 'px';
        document.body.appendChild(emojiPickerEl);
      }
      emojiBtn.addEventListener('click', showEmojiPicker);
      document.addEventListener('click', (e)=> { if(emojiPickerEl && !emojiPickerEl.contains(e.target) && e.target !== emojiBtn) { emojiPickerEl.remove(); emojiPickerEl = null; } });

      function insertAtCursor(textarea, text){
        const start = textarea.selectionStart || 0;
        const end = textarea.selectionEnd || 0;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
      }

      /* username / avatar management */
      setNameBtn.addEventListener('click', async ()=>{
        let val = (usernameInput.value || '').trim();
        if(!val) val = 'Guest' + Math.floor(Math.random()*9000+1000);
        const now = Date.now();
        if(nameChangedAt && now - nameChangedAt < ONE_WEEK_MS){
          alert('You can change your name once per week.');
          return;
        }
        username = val;
        localStorage.setItem('notcord_username', username);
        nameChangedAt = now; localStorage.setItem('notcord_name_changed', String(nameChangedAt));
        setStatus('Name set: ' + username);
      });

      changeAvatarBtn.addEventListener('click', async ()=>{
        if(!avatarInput.files.length){ alert('Choose image first'); return; }
        const file = avatarInput.files[0];
        const now = Date.now();
        if(avatarChangedAt && now - avatarChangedAt < ONE_WEEK_MS){
          alert('You can change avatar once per week.');
          return;
        }
        try{
          const dataUrl = await new Promise((res,rej)=>{
            const fr = new FileReader();
            fr.onload = e => res(e.target.result);
            fr.onerror = ()=> rej('read failed');
            fr.readAsDataURL(file);
          });
          avatarDataUrl = dataUrl;
          avatarChangedAt = now;
          localStorage.setItem('notcord_avatar', avatarDataUrl);
          localStorage.setItem('notcord_avatar_changed', String(avatarChangedAt));
          userAvatarEl.innerHTML = `<img src="${avatarDataUrl}" alt="avatar">`;
          setStatus('Avatar updated');
        }catch(e){ console.warn(e); setStatus('Avatar upload failed'); }
      });

      nameColorInput.addEventListener('input', ()=>{
        nameColor = nameColorInput.value;
        localStorage.setItem('notcord_nameColor', nameColor);
        setStatus('Name color updated');
      });

      /* theme buttons */
      themeButtons.forEach(btn => {
        btn.addEventListener('click', ()=> { applyTheme(btn.getAttribute('data-theme')); });
      });
      // initialize theme
      const savedTheme = Number(localStorage.getItem('notcord_theme') || 1);
      applyTheme(savedTheme);

      /* players fetch (no idle tracking) */
      async function fetchPlayers(){
        try{
          const res = await fetch(PLAYERS_API);
          if(!res.ok) throw new Error('players fetch failed');
          const data = await res.json();
          const list = document.getElementById('playersList'); list.innerHTML = '';
          if(Array.isArray(data)){
            data.forEach(p => {
              const el = document.createElement('div'); el.className='player';
              const dot = document.createElement('div'); dot.className='dot';
              const name = document.createElement('div'); name.textContent = p.name || p.username || ('#'+(p.id||''));
              el.appendChild(dot); el.appendChild(name);
              list.appendChild(el);
            });
          }
        }catch(e){ console.warn(e); }
      }

      /* polling */
      async function startPolling(){
        if(polling) clearInterval(polling);
        await fetchMessages();
        polling = setInterval(fetchMessages, 4000);
        fetchPlayers();
        setInterval(fetchPlayers, 8000);
      }

      /* reply attach support when posting is used; simple because mockapi won't store nested replies reliably */
      // Note: reply metadata will be attached client-side only in optimistic render.

      /* initialization */
      function init(){
        if(username) usernameInput.value = username;
        if(nameColor) nameColorInput.value = nameColor;
        if(avatarDataUrl) userAvatarEl.innerHTML = `<img src="${avatarDataUrl}" alt="avatar">`;
        renderPinned();
        startPolling();
        setStatus('Connected (polling)');
        // wire initial charcount
        messageInput.dispatchEvent(new Event('input'));
      }
      init();

      // Expose for debugging
      window._notcord = { fetchMessages, fetchPlayers, pinned };

    })();
  </script>
</body>
</html>
