<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>notcord ‚Äî Christmas Edition</title>
  <style>
    :root{
      --theme-1: #0b2b26;
      --theme-2: #071a16;
      --theme-3: #1e3d38;
      --muted: #9aa4b2;
      --accent: #c62828;
      --me-bg: #2b3440;
      --border: rgba(255,255,255,0.06);
      --text: #e6eef6;
      --yellow: #f7b500;
      --pin-bg: rgba(198,40,40,0.08);
      --pin-accent: rgba(198,40,40,0.16);
      --christmas-green: #2d7d32;
      --christmas-red: #c62828;
      --christmas-gold: #ffd700;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Helvetica,Arial;color:var(--text);
      background:linear-gradient(180deg,var(--theme-1) 0%, var(--theme-2) 100%);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .app { width:100%; height:100vh; display:grid; grid-template-columns:260px 1fr 260px; overflow:hidden; gap:10px; padding:10px; position:relative; }
    .sidebar{ padding:14px; display:flex; flex-direction:column; gap:12px; height:100vh; overflow:auto; background:linear-gradient(180deg,var(--theme-1),var(--theme-2)); border-radius:12px; border-right:1px solid var(--border) }
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .brand .dot{width:28px;height:28px;border-radius:8px;background:var(--christmas-red);box-shadow:0 8px 26px rgba(198,40,40,0.45);display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
    .brand .name{color:var(--christmas-gold);font-weight:800;font-size:18px}
    .usernameBox{display:flex;gap:8px;align-items:center}
    .usernameBox input{flex:1;padding:10px 12px;background:transparent;border:1px solid var(--border);border-radius:10px;color:inherit;outline:none}
    .usernameBox button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(90deg,var(--christmas-red),#d32f2f);color:white;cursor:pointer}
    .usernameLocked{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid var(--border);font-weight:600;overflow:hidden}
    .usernameLocked .avatar{width:36px;height:36px;border-radius:50%;overflow:hidden;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center}
    .channels{margin-top:6px;display:flex;flex-direction:column;gap:6px}
    .channel{padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer;border:1px solid transparent;display:flex;justify-content:space-between;align-items:center}
    .channel:hover{background:rgba(255,255,255,0.01)}
    .channel.active{background:linear-gradient(90deg, rgba(198,40,40,0.12), rgba(198,40,40,0.02));color:var(--text);border-color:rgba(198,40,40,0.12)}
    .settings{margin-top:auto;display:flex;flex-direction:column;gap:8px;padding-top:8px;border-top:1px solid var(--border)}
    .settings label{font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:6px}
    .settings input[type="color"]{width:48px;height:32px;padding:0;border:none;background:transparent;cursor:pointer}
    .settings .toggleBtn{padding:8px;border-radius:8px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer}

    /* CHAT */
    .chatPanel{display:flex;flex-direction:column;min-height:0;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px;padding:10px;position:relative}
    .chatBox{display:flex;flex-direction:column;height:100%;min-height:0}
    .header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:transparent}
    .header h2{margin:0;font-size:18px}
    .header .spacer{flex:1}
    .status{color:var(--muted);font-size:13px}
    .typing{color:var(--muted);font-size:12px;height:18px}
    .messages{flex:1;overflow:auto;padding:20px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth;min-height:0;background:transparent}
    .pinnedCenter{ position:absolute; left:50%; transform:translateX(-50%); top:10px; z-index:30; background:var(--pin-bg); border:1px solid var(--pin-accent); padding:10px 14px; border-radius:12px; color:var(--text); display:flex; gap:10px; align-items:center; justify-content:center; max-width:70%; text-align:center; box-shadow:0 10px 30px rgba(2,6,23,0.6); transition:opacity .2s ease, transform .15s ease; }
    .pinnedCenter .pin-close{ background: transparent; border: none; color: var(--muted); cursor: pointer; margin-left: 8px; font-weight: 700; }
    .pinnedCenter .pinTitle{font-weight:800;color:var(--christmas-red); margin-right:8px}
    .message{display:flex;gap:12px;align-items:flex-start;max-width:85%}
    .message.me{margin-left:auto;justify-content:flex-end}
    .bubble{
      background:var(--theme-3);
      color:var(--text);
      padding:10px 12px;border-radius:12px;display:flex;flex-direction:column;gap:8px;word-break:break-word;
      border-left:4px solid var(--christmas-green);
      box-shadow:0 8px 28px rgba(2,6,23,0.6);
      max-width:560px;
      position:relative;
      cursor:default;
    }
    .bubble .actions{position:absolute;right:8px;top:6px;display:flex;gap:6px}
    .bubble .actions button{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px;border-radius:6px}
    .meta{display:flex;gap:8px;align-items:center;font-size:13px;color:var(--muted)}
    .meta .name{font-weight:700}
    .meta .time{font-size:12px;color:var(--muted)}
    .text{white-space:pre-wrap;color:inherit;font-size:15px;word-break:break-word;overflow-wrap:break-word}
    .photoMessage img { max-width: 100%; height:auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor:pointer; transition:transform .12s; display:block }
    .photoMessage img:hover{ transform: scale(1.02) }
    .inputArea{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .inputArea textarea{flex:1;min-height:44px;max-height:160px;resize:none;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:inherit;outline:none}
    .controls{display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:120px}
    .charCount{font-size:12px;color:var(--muted)}
    .sendBtn{background:var(--christmas-red);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .sendBtn:disabled{opacity:0.6;cursor:default}
    .photoUploadArea { padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent) }
    .photoUploadArea input[type=file]{ flex:1 }
    .photoUploadArea button{ background:var(--christmas-red); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer }
    .playersPanel{background:linear-gradient(180deg,var(--theme-1),var(--theme-2));border-left:1px solid var(--border);padding:14px;display:flex;flex-direction:column;gap:12px;height:100vh;overflow:auto;border-radius:12px}
    .playersPanel h3{margin:0;font-size:15px;color:var(--muted)}
    .playersList{display:flex;flex-direction:column;gap:6px;overflow:auto}
    .player{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid transparent;color:var(--text)}
    .player.offline{opacity:0.6}
    .player .statusDot{width:10px;height:10px;border-radius:50%;margin-right:8px;flex-shrink:0;border:2px solid rgba(0,0,0,0.12)}
    .player.online .statusDot{background:var(--christmas-green);box-shadow:0 0 8px rgba(45,125,50,0.12)}
    .player.offline .statusDot{background:#a0a0a0}
    .player .playerName{font-weight:600}
    .pinnedArea{border-top:1px dashed rgba(255,255,255,0.03);padding-top:10px;margin-top:8px}
    .pin{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid var(--border);display:flex;gap:8px;align-items:flex-start}
    .pin .meta{font-size:13px}
    .pin .closePin{margin-left:auto;background:transparent;border:none;color:var(--muted);cursor:pointer}
    .mention { background: rgba(198,40,40,0.06); padding:2px 6px; border-radius:6px; font-weight:700; color:var(--christmas-red); }
    
    /* Christmas decorations */
    .christmas-decoration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }
    .snowflake {
      position: absolute;
      color: white;
      font-size: 1em;
      animation: fall linear infinite;
      pointer-events: none;
      top: -50px;
    }
    @keyframes fall {
      to { transform: translateY(calc(100vh + 50px)) rotate(360deg); }
    }
    
    /* Code message styles */
    .code-block {
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 12px;
      padding-top: 36px;
      margin: 8px 0;
      position: relative;
      border: 1px solid rgba(255,255,255,0.1);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--christmas-green);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .copy-btn:hover {
      background: var(--christmas-red);
    }
    .copy-btn.copied {
      background: var(--christmas-gold);
      color: #000;
    }
    .language-tag {
      position: absolute;
      top: 8px;
      left: 8px;
      background: var(--christmas-red);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
    }
    
    @media (max-width:980px){ .app{grid-template-columns:200px 1fr 140px} }
    @media (max-width:720px){ .app{grid-template-columns:1fr} .sidebar,.playersPanel{display:none} }
  </style>
</head>
<body>
  <div class="christmas-decoration" id="snowflakes"></div>
  
  <div class="app" id="app">
    
    <aside class="sidebar" id="sidebar">
      <div class="brand"><div class="dot" aria-hidden>üéÑ</div><div class="name">notcord</div></div>

      <div id="usernameSection">
        <div class="usernameBox" id="usernameBox">
          <input type="text" id="usernameInput" placeholder="Choose username (max 8 chars)" maxlength="8" />
          <input type="file" id="avatarInput" accept="image/*" title="Upload avatar (weekly)"/>
          <button id="setNameBtn">Set</button>
        </div>
        <div class="usernameLocked" id="usernameLocked" style="display:none">
          <div class="avatar" id="avatarDisplay"></div>
          <div style="display:flex;flex-direction:column;gap:4px">
            <div id="usernameDisplay"></div>
            <div style="font-size:12px;color:var(--muted)" id="nameMeta"></div>
          </div>
          <div style="margin-left:auto;display:flex;flex-direction:column;gap:6px">
            <button id="changeNameBtn" class="toggleBtn">Change</button>
            <button id="changeAvatarBtn" class="toggleBtn">Avatar</button>
          </div>
        </div>
      </div>

      <div class="channels" id="channels">
        <div class="channel active" data-id="general" role="button"># general</div>
        <div class="channel" data-id="photos" role="button"># photos</div>
        <div class="channel" data-id="code" role="button"># code üéÖ</div>
      </div>

      <div class="settings" aria-label="Appearance settings">
        <label>Your name color
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="nameColor" title="Name color" />
            <div style="flex:1"></div>
            <button id="resetNameColor" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>Theme Color 1
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="themeColor1" title="Theme color 1" />
            <div style="flex:1"></div>
            <button id="resetTheme1" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>Theme Color 2
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="themeColor2" title="Theme color 2" />
            <div style="flex:1"></div>
            <button id="resetTheme2" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>Theme Color 3
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="themeColor3" title="Theme color 3" />
            <div style="flex:1"></div>
            <button id="resetTheme3" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label>Accent Color
          <div style="display:flex;gap:8px;align-items:center">
            <input type="color" id="accentColor" title="Accent color" />
            <div style="flex:1"></div>
            <button id="resetAccent" class="toggleBtn">Reset</button>
          </div>
        </label>

        <label style="display:flex;flex-direction:row;justify-content:space-between;align-items:center">
          <span>Particles</span>
          <button id="particlesToggle" class="toggleBtn">ON</button>
        </label>

        <div style="font-size:12px;color:var(--muted);padding-top:6px">
          Username/Avatar change limited to once per 7 days. Use "@name" to ping. Pinned message shown top center for everyone.
        </div>
      </div>
    </aside>

    <section class="chatPanel">
      <div class="chatBox" id="chatBox">
        <div class="header">
          <h2 id="channelTitle"># general</h2>
          <div class="spacer"></div>
          <div class="right">
            <div id="status" class="status">Connecting...</div>
            <div id="typingIndicator" class="typing"></div>
          </div>
        </div>

        <div id="pinnedCenter" class="pinnedCenter" style="display:none"></div>

        <div class="messages" id="messages" role="log" aria-atomic="false"></div>

        <div class="inputArea" id="inputWrapper">
          <textarea id="messageInput" placeholder="Message (Shift+Enter for newline)" maxlength="2000"></textarea>
          <div class="controls">
            <div class="charCount" id="charCount">0 / 100</div>
            <button id="sendBtn" class="sendBtn" disabled>Send</button>
          </div>
        </div>

        <div class="photoUploadArea" id="photoUploadWrapper" style="display:none">
          <input type="file" id="photoInput" accept="image/*,image/gif" />
          <button id="uploadPhotoBtn" disabled>Upload Photo/GIF</button>
        </div>
        
        <div class="codeUploadArea" id="codeUploadWrapper" style="display:none">
          <textarea id="codeInput" placeholder="Paste your code here (no limits!)" style="width:100%;min-height:120px;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--border);color:inherit;outline:none;font-family:'Courier New',monospace"></textarea>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input type="text" id="languageInput" placeholder="Language (e.g., javascript, python)" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid var(--border);color:inherit;outline:none">
            <button id="uploadCodeBtn" style="background:var(--christmas-green);color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer">Upload Code</button>
          </div>
        </div>
      </div>
    </section>

    <aside class="playersPanel" id="playersPanel">
      <h3>Players üéÅ</h3>
      <div id="playersStatus" style="font-size:13px;color:var(--muted)">Loading...</div>
      <div style="height:6px"></div>
      <div class="playersList" id="playersList" aria-live="polite"></div>

      <div class="pinnedArea" id="pinnedArea">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-size:13px;color:var(--muted)">Pinned</div>
          <button id="pinClearBtn" class="toggleBtn">Clear</button>
        </div>
        <div id="pinsList" style="margin-top:8px;display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </aside>
  </div>

  <script>
    (function(){
      // --- Endpoints ---
      const CHANNELS = {
        general: 'https://68e839b2f2707e6128ca35e1.mockapi.io/chat',
        photos: 'https://68eeed86b06cc802829ba196.mockapi.io/photos',
        code: 'https://68eeed86b06cc802829ba196.mockapi.io/code'
      };
      const PLAYERS_API = 'https://68e839b2f2707e6128ca35e1.mockapi.io/players';
      const PINS_PUBLIC_API = 'https://6907fcb5b49bea95fbf20cbc.mockapi.io/pined';

      // --- Config ---
      const BAD_WORDS = ['fuck','bitch','nigger','tun tun tun sahur','–Ω–∞—Ö—É–π','–≥–µ–π','gay','—Ö—É–µ—Ç–∞'];
      const MAX_MESSAGES_KEEP = 80;
      const TRIM_DELETE_COUNT = 20;

      // --- UI refs ---
      const channelsEl = document.getElementById('channels');
      const channelTitleEl = document.getElementById('channelTitle');
      const messagesEl = document.getElementById('messages');
      const statusEl = document.getElementById('status');
      const typingIndicatorEl = document.getElementById('typingIndicator');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const charCountEl = document.getElementById('charCount');
      const inputWrapper = document.getElementById('inputWrapper');
      const photoUploadWrapper = document.getElementById('photoUploadWrapper');
      const photoInput = document.getElementById('photoInput');
      const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
      const codeUploadWrapper = document.getElementById('codeUploadWrapper');
      const codeInput = document.getElementById('codeInput');
      const languageInput = document.getElementById('languageInput');
      const uploadCodeBtn = document.getElementById('uploadCodeBtn');

      const usernameBox = document.getElementById('usernameBox');
      const usernameInput = document.getElementById('usernameInput');
      const setNameBtn = document.getElementById('setNameBtn');
      const usernameLocked = document.getElementById('usernameLocked');
      const usernameDisplay = document.getElementById('usernameDisplay');
      const avatarInput = document.getElementById('avatarInput');
      const avatarDisplay = document.getElementById('avatarDisplay');
      const changeNameBtn = document.getElementById('changeNameBtn');
      const changeAvatarBtn = document.getElementById('changeAvatarBtn');
      const nameMeta = document.getElementById('nameMeta');

      const nameColorInput = document.getElementById('nameColor');
      const resetNameColorBtn = document.getElementById('resetNameColor');
      const themeColor1Input = document.getElementById('themeColor1');
      const resetTheme1Btn = document.getElementById('resetTheme1');
      const themeColor2Input = document.getElementById('themeColor2');
      const resetTheme2Btn = document.getElementById('resetTheme2');
      const themeColor3Input = document.getElementById('themeColor3');
      const resetTheme3Btn = document.getElementById('resetTheme3');
      const accentColorInput = document.getElementById('accentColor');
      const resetAccentBtn = document.getElementById('resetAccent');
      const particlesToggleBtn = document.getElementById('particlesToggle');

      const playersListEl = document.getElementById('playersList');
      const playersStatusEl = document.getElementById('playersStatus');

      const pinsListEl = document.getElementById('pinsList');
      const pinClearBtn = document.getElementById('pinClearBtn');
      const pinnedCenterEl = document.getElementById('pinnedCenter');

      // --- State ---
      let activeChannel = localStorage.getItem('notcord_channel') || 'general';
      let apiBase = CHANNELS[activeChannel] || null;
      let polling = null;
      let playersPolling = null;
      let heartbeatInterval = null;
      let isSending = false;
      const MAX_CHARS = 256;
      const TYPING_KEY = 'notcord_typing_v3';
      const TYPING_EXPIRE_MS = 5000;
      const HEARTBEAT_MS = 5000;

      let username = localStorage.getItem('notcord_username') || '';
      let nameColor = localStorage.getItem('notcord_nameColor') || '#ffcc00';
      let themeColor1 = localStorage.getItem('notcord_theme1') || '#0b2b26';
      let themeColor2 = localStorage.getItem('notcord_theme2') || '#071a16';
      let themeColor3 = localStorage.getItem('notcord_theme3') || '#1e3d38';
      let accentColor = localStorage.getItem('notcord_accent') || '#c62828';
      let particlesEnabled = localStorage.getItem('notcord_particles') !== 'false';
      let localPlayerId = localStorage.getItem('notcord_playerId') || null;

      const WEEK_MS = 7 * 24 * 60 * 60 * 1000;
      let lastNameChange = Number(localStorage.getItem('notcord_lastNameChange') || 0);
      let lastAvatarChange = Number(localStorage.getItem('notcord_lastAvatarChange') || 0);
      let avatarDataUrl = localStorage.getItem('notcord_avatar') || null;

      let pinned = JSON.parse(localStorage.getItem('notcord_pinned') || '[]');
      const muteMap = new Map();

      // Track notifications already sent
      const notifiedKey = 'notcord_notified_messages';
      let notifiedSet = new Set(JSON.parse(localStorage.getItem(notifiedKey) || '[]'));

      // interval id for pin rotation
      let pinRotationIntervalId = null;
      let publicPinnedList = [];

      // reply state
      let replyToMessage = null;

      // --- Helpers ---
      function setStatus(txt){ statusEl.textContent = txt; }
      function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
      function formatTime(iso){ try{ const d=new Date(iso); if(isNaN(d)) return ''; return d.toLocaleString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){return ''} }
      function applyTheme(){ 
        document.documentElement.style.setProperty('--theme-1', themeColor1); 
        document.documentElement.style.setProperty('--theme-2', themeColor2); 
        document.documentElement.style.setProperty('--theme-3', themeColor3); 
        document.documentElement.style.setProperty('--accent', accentColor); 
      }
      function initializeAppearanceInputs(){ 
        nameColorInput.value = nameColor;
        themeColor1Input.value = themeColor1;
        themeColor2Input.value = themeColor2;
        themeColor3Input.value = themeColor3;
        accentColorInput.value = accentColor;
        particlesToggleBtn.textContent = particlesEnabled ? 'ON' : 'OFF';
      }

      function readTypingMap(){ try{ return JSON.parse(localStorage.getItem(TYPING_KEY)||'{}'); }catch(e){ return {}; } }
      function writeTypingMap(m){ try{ localStorage.setItem(TYPING_KEY, JSON.stringify(m)); }catch(e){} }
      function updateTypingUI(){
        const map = readTypingMap();
        const channelMap = map[activeChannel] || {};
        const now = Date.now();
        const typers = Object.keys(channelMap).filter(u => u !== username && (now - channelMap[u]) <= TYPING_EXPIRE_MS);
        if(!typers.length) typingIndicatorEl.textContent = '';
        else if(typers.length === 1) typingIndicatorEl.textContent = typers[0] + ' is typing...';
        else typingIndicatorEl.textContent = typers[0] + ' and ' + (typers.length-1) + ' others are typing...';
      }
      window.addEventListener('storage', (e)=> { if(e.key === TYPING_KEY) updateTypingUI(); });

      function isUserMuted(user){
        const t = muteMap.get(user);
        if(!t) return false;
        if(Date.now() > t){ muteMap.delete(user); return false; }
        return true;
      }
      function muteUser(user, seconds=120){ muteMap.set(user, Date.now() + seconds*1000); }

      function containsBadWords(text){
        if(!text) return false;
        const lower = text.toLowerCase();
        return BAD_WORDS.some(w => w && lower.includes(w));
      }

      // Christmas snowflakes
      function createSnowflakes() {
        const snowflakesContainer = document.getElementById('snowflakes');
        snowflakesContainer.innerHTML = '';
        if (!particlesEnabled) return;
        
        const snowflakes = ['I am going to do it. I have made up my mind. These are the first few words of the new‚Ä¶ the best ‚Ä¶ the Longest Text In The Entire History Of The Known Universe! This Has To Have Over 35,000 words the beat the current world record set by that person who made that flaming chicken handbooky thingy. I might just be saying random things the whole time I type in this so you might get confused a lot. I just discovered something terrible. autocorrect is on!! no!!! this has to be crazy, so I will have to break all the English language rules and the basic knowledge of the average human being. I am not an average human being, however I am special. no no no, not THAT kind of special ;). Why do people send that wink face! it always gives me nightmares! it can make a completely normal sentence creepy. imagine you are going to a friend‚Äôs house, so you text this: [ see you soon üôÇ ] seems normal, right? But what is you add the word semi to that colon? (Is that right? or is it the other way around) what is you add a lorry to that briquettes? (Semi-truck to that coal-on) anyway, back to the point: [ see you soon üòâ ]THAT IS JUST SO CREEPY! is that really your friend, or is it a creepy stalker watching your every move? Or even worse, is it your friend who is a creepy stalker? maybe you thought it was your friend, but it was actually your fri end (let me explain: you are happily in McDonalds, getting fat while eating yummy food and some random dude walks up and blots out the sun (he looks like a regular here) you can‚Äôt see anything else than him, so you can‚Äôt try to avoid eye contact. he finishes eating his cheeseburger (more like horseburgher(I learned that word from the merchant of Venice(which is a good play(if you can understand it(I can cause I got a special book with all the words in readable English written on the side of the page(which is kinda funny because Shakespeare was supposed to be a good poet but no-one can understand him(and he‚Äôs racist in act 2 scene1 of the play too))))))) and sits down beside you , like you are old pals (you‚Äôve never met him before but he looks like he could be in some weird cult) he clears his throat and asks you a very personal question. ‚Äúcan i have some French fries?‚Äù (I don‚Äôt know why there called French fries when I‚Äôve never seen a French person eat fries! all they eat it is stuff like baguettes and cr√™pes and rats named ratty-two-ee which is a really fun game on the PlayStation 2) And you think {bubbly cloud thinking bubble} ‚ÄúHahahahahhahahahahahahahaha!!!!!!!!!!!! Hehheheheheh‚Ä¶..heeeheehe..hehe‚Ä¶ sigh. I remember that i was just about to eat one of my fries when I noticed something mushy and moist and [insert gross color like green or brown] on the end of one of my fries! now I can give it to this NERD!! ‚Äù (yes he is a nerd because all he does all day is watch the extended editions of the hobbit, lord of the rings and star wars and eat fat cakes (what the heck is a fat cake? I think it might be like a Twinkie or something)and twinkies(wow so is doesn‚Äôt really matter which is which because he eats both(i may have just done that so I didn‚Äôt have to Google what a fat cake is (right now I am typing on my iPhone 3gs anyway, which has a broken antenna so i can‚Äôt get internet anyway (it‚Äôs actually a really funny story that i‚Äôll tell you sometime)))and sit in his man cave with his friend named Joe (an ACTUAL friend, not a fri end)and all Joe does is watch sports like football with bob and all bob does is gamble ferociously (don‚Äôt ask(it means he buys all those bags of chips that say ‚Äúwin a free monkey or something if you find a banana in your bag*‚Äù(if there is a little star it means there is fine print so I always check the back of the package) *flips over the package* okay, it says: ‚Äúone of our workers accidentally threw a banana in the packing machine and we don‚Äôt want to get sued so we did this promotion thing‚Äù cool. Oh wow, this is salt and vinegar! my favourite! i hate cheese and onion.))and that‚Äôs pretty much his life, he lives in Jamaica with Naruto and his friends) so you give him that gross fri end he throws up all over you and me and the worker behind the counter who was still making an onion, and THAT is the story of the fri end, not a friend who somehow remembered your name and your phone number / email so he could text you saying he would come to your house soon. *finally takes a breath after typing a few hundred words about fri-ends* so what now? i know, i know, you think i ramble too much and use too many brackets (i don‚Äôt) but now i am going to talk about my amAZEing day. first i woke up, ate choco pops for breakfast even tho i always hate it when people say that cause i get jealous and super hungry. then i‚Ä¶ umm‚Ä¶ yea! that was my day. you know that other person i mentioned before? that flaming chicken person? WELL. i will steal something from that person but do it better. i will‚Ä¶ drum roll please ‚Ä¶ badabadabadabadabadabadabummmmmmmmmmmchshchshchshchshbadabadboumboumpoopoopichypichypichypowpow-crash! *a drum roll was just playing in the background* that drumroll was so long i forget what i was talking about. *scrolls up to see what he was writing about* oh yea! i will make my own FLAMING CHICKEN HANDBOOK! what things do i like? instead of flaming it could be rainbow, instead of chicken it could be fluffysheep and instead of handbook it could be handbook (not very creative, i know) but the total complete name is now to rainbow fluffysheep handbook! to make life easier for you guys, instead of taking random rules out of book willy nilly, i will take them out using my favourite numbers! so, section 5040 of the rainbow fluffysheep handbook states that the king of all oddly coloured farm animals (thats me!) is allowed to tell you any part out of this book randomly or if it is his one of his favorite numbers! 5040 is a great number because it is divisible by 60 integers which i don‚Äôt know. i‚Äôm tired. it is 10:41 and i am getting sleepy‚Ä¶ hey hey hey! an intruder! remember that from pokepals rulers of time and darkness or something like that! with piplup and sunflora and chimchar! whaoh piplup is really hard to write on a tiny qwerty keyboard! try it! i realised that asdf is actually written in order on the qwerty keyboard! (just in case you didn‚Äôt know, asdf is an amazing short video clips cartoony thing on youtube i first learned bout on flipnote hatena, which is now shut down üò¶ ) what if one day they get rid of the qwerty keyboard completely! i will type it out for you just in case one day they get rid of it. qwertyuiopasdfghjklzxcvbnm. there u go. Goodbye. I‚Äôm back! i decided that i should tell you about fonts. i always used the same font for my whole life, called arial. the reason is probably because it is on the top of the list in alphabetical order, and i was too lazy to scroll all the way down. only a few months ago did i finally decide to change my mind. i scrolled for what seemed to be an eternity, and i finally got to‚Ä¶ are you ready ‚Ä¶ arial black. yep, that was my big SCROLLING ADVENTURE! just yesterday, i was typing something on google docs and i found the new best font : roboto. its great! i could choose from FIVE different thicknesses. isn‚Äôt that amazing? right now we are driving behind a really slow ‚Äúfarm plastics collection‚Äù semi. i think i know someone obsessed with pokemon, but i can‚Äôt tell you who it is. he keeps making pokepals references and stuff. wow! you are a very loyal reader! if you have REALLY made it this far then you‚Ä¶ get a gold star on your loyalty chart! good job! this is looking to be the longest text ever, considering that this was all written in one day. i don‚Äôt understand sandwiches. if you were to eat bread, mayo and tomatoes separately it would be disgusting! you know all those fancy magazines/restaurants that always have really fancy food pictures with meat and brussels sprouts and all the old people say ‚Äúwow! that looks great!‚Äù and you think {bubble thing} ‚Äúit looks like the worst thing anyone could ever eat‚Äù and the you eat it and it tastes surprisingly‚Ä¶ WORSE than you imagined! gotta go‚Ä¶ im back! ive ive got stuff to say! your probably thinking‚Ä¶ HoW DoEs He HaVe So MuCh FrEe TiMe?!?! And the answer is‚Ä¶ i don‚Äôt. that‚Äôs right. this isn‚Äôt just some SIDE project. i‚Äôve gotta make time to do this if wanna get the world record. for all i know, the flaming chicken opponent who i will refer to from now on as sam (i don‚Äôt know why) is probably still adding to her posts. (i think i picked sam because it sounds like ham which is like cooked meat and so is flaming chicken, so you will remember that now ) i am officially going to make a quote from the rainbow fluffysheep handbook of knowledge and prestige (sounds catchy, huh?) . section 777 of the rainbow fluffysheep handbook STATES that the king of oddly colored farm animals (thats me!) is allowed to use whatever font he wants to. [now, i know what your thinking reader, that has nothing to do with anything. but it will come in handy someday (maybe)] sam makes me feels sick! im offended! (probably because i‚Äôm jealous of how much is written on that website(i dont even know how to make a website)) I‚ÄôVE JUST BEEN READING THIS AND I HAVE DISCOVERED A CONSPIRACY! THAT‚ÄôS RIGHT, I AM WORKING FOR DOCTOR SUESS! YES! i will prove it to you. i mentioned ham and sickness so green eggs and ham somehow! (why is he called doctor suess anyway? he‚Äôs not even a doctor *citation needed* and his books are kinda dumb! (funny considering i‚Äôm the one making that statement)) talking about eggs, aren‚Äôt eggs practically unborn chicken membrane? wouldn‚Äôt it be scary if you were casually eating your brembudder (riotous robots reference (wow! serious compilation of alliteration dedication!)) and drinking your tae wit‚Äô da guv‚Äôna (england doesn‚Äôt even have a govna! *citation needed*)(i‚Äôm not even racist i‚Äôm just quoting an accent of a race) and you go to crack an egg for your brekkie and BOOM! and unborn chicken embryo starts running towards you, picks up a knife and starts screaming ‚ÄúMAMA! MAMA!‚Äù you are so scared that you grab the nearest weaponry (a spoon) and poke the hideous beast. it is unaffected. luckily, the govener of Berwick-Upon-Tweed throws a sugar cube directly into the chicks mouth! as you know, sugar is EXTREMELY poisonous to chicken embryos *citation needed* (no more citations!) and you are saved! i‚Äôm sick and tired of citations! i will quote from the official rainbow fluffysheep handbook! section 12345679 (all the mathematicians are nodding their heads while the OCD people are twitching nervously in the corner) says that the king of oddly coloured farm animals does not have any obligation to write if a false piece of information needs a citation. great! now i feel like a free person! free i tell you, free! free from the prison cell i call the boundaries of untrue info. i think since im going to be the president of somewhere someday, i should have great speech here it goes: Hello great people of [name of place]! i am here to tell you; I am going to make [name of place] great again! i am going to lower taxes, but increase happiness! i am going to buy dog sweaters and bowls for people with dogs, and do some renovations on peoples tents! yes, this truly is a new era, the era of Epicness And Coolness! {and so, his tale lived on forever, being passed on generation to generation, living vividly in the hearts of the people.(that last bit sounded like the ending of an Asterix comic.)} i will now PROVE that all these things can happen. the first thing i said was that i will make America (i know, i know, i gave it away and told you the name) place grape again. (yes, that is what i said, bear with me here) i hereby DECLARE that every piece of American soil must be covered in vineyards. someone told me i should do that. i think i heard it through the grapevine (bad jokethat nobody understands) the next step is to lower taxes and raise happiness. to lower taxes i will get rid of all hospitals, and spend the taxes all on building fun playgrounds. this in turn, raises happiness (for the kids and for the non-injured if you know what i mean). finally, i will buy dog sweaters (on sale at your local liquidation world!) and dog bowls (just use little human bowls maybe?) and last but not least i will do renos on peoples tents (send chip and joanna from Fixer Upper to all the camping places). and, since all i said was (partial) truth, it will be a great era. anyway, gotttttttttttaaaaaaa ggggoooooo. bbbbbuuuuuuyyyy! im back. i just had thanksgiving while listening to christmas music and it was fun. we had bacon, ham and chicken but no turkey. its fall, but it‚Äôs ACTUALLY winter secretly. im watching a funny show. i‚Äôm back (even though i never said i was gone so you might be confused) hello loyal reader! if you have gotten this far without SKIMMING THROUGH then you are probably either lying, extremely bored (but not after reading this whole thing!) or VERY and i mean VERY dedicated. or all three. you know those homeless people that sit on the ground and ask for money? i think its all a conspiracy! after all, uow can they afford those dogs, sharpies, cardboard and enough english education to write ‚Äúneed help‚Äù? back in the roman times, only the richest, most important people could get things like that! you know the new fad, ‚Äòblack surfboards‚Äô? (neither did i until 15 seconds ago) someone related to me thinks they look really cool, i think they are neat but SOMEONE also related to me thinks they are bad because they would get warped. someWHERE ohohohohohohover the rainbowwwwww that reminds me, i was doing my normal thing, when BOOM! i started typing NONSENSE. so here it is, but be warned. its SCARILY NONSENSICAL. HeRe GoEs: The Epicness ‚Äì Hi how are you? Smells good ya! Think about that buddy (shower time) heheheheHAHAHA well thanks a lot so called buddy. Random things: joe be utterly hatin. Dat be da bomb ‚Äì Tink about tanking me. Interview: how does Joe like his pepperoni? ‚ÄúI be liken how I always eat it.‚Äù What first comes to Bobby‚Äôs mind when I say flabbergast? I don‚Äôt know, Flapper dress maybe that be it (20s style) hey dere ma-name JeFf‚Ä¶ Hell Ome Ine Ame Isej oe hey hey hey! an intruder! (DID U NEVER WATCH POK√âPALS?!?! im offended.) ANYHOO, the cattle hopped above the earth orbiting asteroid (a TWIST on an old tale) Are you OCD? Then don‚Äôt read anymore: :):):):):):):):):):);):):):):):) OR: 8)8)8)8)8)8)8)8)9)8)8)8) (I Know It‚Äôs Annoying} ocd&gmail.com [i annoyed you again) ‚ÄîA Nice Story‚Äî {one day an old man said yonder} heyyyyyyy üòâ (WHY DID HE WINK AT ME IT‚ÄôS SO CREEPY) {the old man continued} hellllloooooo there young laddddiiee boyyyy (I NEED TO GET AWAY FROM THIS MAN) i think I‚Äôve‚Ä¶ SEEN YE ARE OUND BAE FAR HAVANT AYE? üòâ (TAKE ME AWAY FROM THIS HIDEOUS BEAST YOU CALL A MAN! I WAS ONCE A HAPPY BOY, AND THEN HHHEEE STARTED TALKING!!!?!?!?! THIS IS UNNNNNACCEPTABLE!! :):):):):):):) mwahahaha! üòâ MY ATTACK PLAN IS READY!) {THIS IS WHAT HAPPENED} üòâ kills -> üôÇ ‚ÄîThe End‚Äî Today is the day of justice. Today the world will be DESTROYED! Mwahahahah! Someday the whole peanut of existence will be chipped into The Edge. But then again, maybe it will be forever remembered as the one who saved the mintrolls from the mighty Orc king, and the one who was forever changed; transformed into a giant floating peanut. hello it‚Äôs me i was wondering if after all these years you would like to meet -> hey chow gotta beat chow gotta beat chow Hey HEY____________________W W W W W[]_____/\__<>___/\_____ GEOmetry DAESH One day i want to fie to da MOOOOOON!! aheyhayhoy. soametime the sky looke BLOOE, but it actually YALLOE. af yow cane andarstend dis santanse dan yowr umaizang. somedaaaaaaaaaaaaaay, OVer theRAINBOW, WAY UP HI,Oe‚Äôr da skie -> @,|3,[,|),¬£,|=,‚Ç¨,|-|,|,7,|<,|_,/\/\,/\/,[],|*,0-,|~,$,-|-,\_/, \/,\/\/,}{,¬•,%. |-|¬£||[], /\/\¬• /\/@/\/\¬£ |$ |3[]|3|3¬•. | @/\/\ \/\/|~|-|-|/\/‚Ç¨ |/\/ @ $¬£[|~¬£-|- [[]|)¬£ []/\/|¬• @ |-|\_//\/\@/\/ [@/\/ \_//\/|)¬£|~$-|-@/\/|). That was it. i know what your thinking (i think i do at least) but i‚Äôm not going to tell you. BURNED! HAHAHAHAHAHAHAHA FEELS THE BURN! sorry, i had to much sugar üôÇ gotta go you know bro do. I‚Äôm back! and i gotta new conspiracy for u! you know how EVERY child hates brussels sprouts! this is why i think so. Brussels sprouts were happily growing in their belgiumy home. everyone loved them! they were the chicken nuggets of the vegetable world. when suddenly‚Ä¶ DA DADA DA! Hitler comes to Belgium (dont read this if you don‚Äôt want to. hitler was happily taking over Austria and Poland when he then decided to take over France but France built a big wall thing to keep him out on the border between france and Germany so all Hitler did was go through Belgium to get to France and THAT is when our story is taking place.) and he makes all the brussles sprouts taste bad simply because he is near them! the Mulligan family is about to go to McRonalds and order 43 brussels sprouts (you would have to have been paying very close attention and know some math to understand that joke) and when they get them (after lots of quarrels with the manager (a bit of a parker square if you ask me (you probably don‚Äôt understand that either(if you want to feel like you know all these inside jokes, just look em up on the web! your sure to find the videos made by lumberpile(close enough))))) they taste so bad you throw up everywhere! Hitler may have caused WWII, but he also caused brussels sprouts to taste bad. so there you go. why do they always write WWII? (if you can‚Äôt tell, they always write double-u double-u eye eye) wouldn‚Äôt it be more accurate to write WW11 or WW2? If i keep writing at this rate, i‚Äôll beat the world record in no time! i might even print it all off and write a novel! too bad i probably don‚Äôt have any readers. hello there non existent reader! i hope you are having fun. and i hope you are not injured cuz of that whole ‚Äòno hospitals‚Äô conundrum. what else should i talk about? how bout Minecraft? just in case you don‚Äôt know, Minecraft is a fun game where you place blocks and stuff and you play with friends and most people who play it are like 10 years old but I not and i still have fun and you can‚Äôt judge me because I wanna be an engineer and if I wanna be an engineer then i should probably not waste my time playing games wow that went downhill from benefitting me really quickly. Anyway, I prefer the Redstone side of things (Redstone means wiring and stuff). I build stuff like 5 piston extenders and auto wall builders and calculators and computers (not those stupid computers that use command blocks (just in case you don‚Äôt know people, command blocks are like CHEATING THINGS and if I am talking about them i will probably not be happy)) and stuff cause i wanna be an inventor. I also do c++ and make things like search engines, text adventures and cookie clickers! My current BIGGEST project is 600 lines long and I don‚Äôt know if that‚Äôs a lot but it sure seems like it to me! (when I was typing in the word lines it auto corrected it to ‚Äòlies‚Äô) what‚Äôs with the whole naming appliances fad going on? (There isn‚Äôt really one) like that vacuum named ‚ÄòHenry‚Äô that I have. I have the box here and it says on it it can twist the top part which I never knew before! I just woke up but the anticipation of whether this whole Henry twist bit this is true is killing me and I think I might wake up just to see if its true. Nahhhhhhhhhhh! This text is getting so long it‚Äôs getting laggy just typing on the same notes on my phone! I gotta start a new one. See you in another life, brother (Desmond in Lost reference). iiitttttttttsssss Johnny! I‚Äôm someone mcmann and today we are taking with bee mc wasp.'];
        
        for (let i = 0; i < 20; i++) {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
          snowflake.style.left = Math.random() * 100 + '%';
          snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
          snowflake.style.animationDelay = Math.random() * 5 + 's';
          snowflake.style.opacity = Math.random() * 0.5 + 0.3;
          snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
          snowflakesContainer.appendChild(snowflake);
        }
      }

      function toggleParticles() {
        particlesEnabled = !particlesEnabled;
        localStorage.setItem('notcord_particles', particlesEnabled);
        particlesToggleBtn.textContent = particlesEnabled ? 'ON' : 'OFF';
        createSnowflakes();
      }

      // --- Pins ---
      function savePinned(){ localStorage.setItem('notcord_pinned', JSON.stringify(pinned)); renderPinnedLocal(); }
      function renderPinnedLocal(){
        pinsListEl.innerHTML = '';
        for(const p of pinned){
          const div = document.createElement('div'); div.className = 'pin';
          const meta = document.createElement('div'); meta.className = 'meta';
          const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = p.username;
          const time = document.createElement('div'); time.style.fontSize='12px'; time.style.color='var(--muted)'; time.textContent = formatTime(p.createdAt);
          const text = document.createElement('div'); text.style.marginTop='6px'; text.textContent = p.message || '';
          meta.appendChild(name); meta.appendChild(time); meta.appendChild(text);
          const btn = document.createElement('button'); btn.className='closePin'; btn.textContent='Unpin';
          btn.onclick = ()=>{ pinned = pinned.filter(x=>x.id !== p.id); savePinned(); };
          div.appendChild(meta); div.appendChild(btn);
          pinsListEl.appendChild(div);
        }
      }

      pinClearBtn.addEventListener('click', ()=>{ pinned = []; savePinned(); });

      async function fetchPublicPinned(){
        try{
          const res = await fetch(PINS_PUBLIC_API);
          if(!res.ok) throw new Error('failed fetching public pins');
          let data = await res.json();
          if(!Array.isArray(data)) data = [];
          publicPinnedList = data.filter(p => p && p.message && p.message.trim());
        }catch(e){ console.error(e); publicPinnedList = []; }
      }

      function startPinRotation(interval_ms=7000){
        if(pinRotationIntervalId) clearInterval(pinRotationIntervalId);
        let idx = 0;
        function rotatePins(){
          if(publicPinnedList.length === 0){ pinnedCenterEl.style.display='none'; return; }
          const p = publicPinnedList[idx % publicPinnedList.length];
          if(p && p.message){
            pinnedCenterEl.innerHTML = `<span class="pinTitle">üìå PIN:</span> <span style="font-weight:600">${escapeHtml(p.message)}</span>`;
            pinnedCenterEl.style.display = 'flex';
          } else {
            pinnedCenterEl.style.display = 'none';
          }
          idx = (idx+1) % publicPinnedList.length;
        }
        rotatePins();
        pinRotationIntervalId = setInterval(rotatePins, interval_ms);
      }

      // --- Players ---
      async function fetchPlayers(){
        try{
          const res = await fetch(PLAYERS_API);
          if(!res.ok) throw new Error('players fetch fail');
          let data = await res.json();
          if(!Array.isArray(data)) data = [];
          const now = Date.now();
          const ONLINE_THRESHOLD_MS = 11000;
          const sorted = data.sort((a,b)=>{
            const aTime = a.lastSeen ? new Date(a.lastSeen).getTime() : 0;
            const bTime = b.lastSeen ? new Date(b.lastSeen).getTime() : 0;
            const aOnline = a.online && (now - aTime < ONLINE_THRESHOLD_MS);
            const bOnline = b.online && (now - bTime < ONLINE_THRESHOLD_MS);
            if(aOnline && !bOnline) return -1;
            if(!aOnline && bOnline) return 1;
            return bTime - aTime;
          });
          const total = sorted.length;
          const onlineList = sorted.filter(p => {
            const pTime = p.lastSeen ? new Date(p.lastSeen).getTime() : 0;
            return p.online && (now - pTime < ONLINE_THRESHOLD_MS);
          });
          const onlineCount = onlineList.length;
          playersStatusEl.textContent = `${onlineCount} online / ${total} total`;
          playersListEl.innerHTML = '';
          for(const p of sorted){
            const pTime = p.lastSeen ? new Date(p.lastSeen).getTime() : 0;
            const isOnline = p.online && (now - pTime < ONLINE_THRESHOLD_MS);
            const div = document.createElement('div');
            div.className = 'player ' + (isOnline?'online':'offline');
            const dotSpan = document.createElement('span');
            dotSpan.className = 'statusDot';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'playerName';
            nameSpan.textContent = p.name || 'Anonymous';
            if(p.nameColor){
              nameSpan.style.color = p.nameColor;
            }
            const avatarEl = document.createElement('div');
            avatarEl.style.width='20px';
            avatarEl.style.height='20px';
            avatarEl.style.borderRadius='50%';
            avatarEl.style.overflow='hidden';
            avatarEl.style.marginLeft='8px';
            avatarEl.style.display='flex';
            avatarEl.style.alignItems='center';
            avatarEl.style.justifyContent='center';
            avatarEl.style.background='rgba(255,255,255,0.03)';
            if(p.avatarUrl){
              const img = document.createElement('img');
              img.src = p.avatarUrl;
              img.style.width='100%';
              img.style.height='100%';
              img.style.objectFit='cover';
              avatarEl.appendChild(img);
            }
            div.appendChild(dotSpan);
            div.appendChild(nameSpan);
            div.appendChild(avatarEl);
            playersListEl.appendChild(div);
          }
        }catch(e){ console.error(e); }
      }

      async function safeFetch(url, method='GET', body=null){
        const opts = { method, headers:{'Content-Type':'application/json'} };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(url, opts);
        return res;
      }

      async function upsertLocalPlayer(){
        if(!username) return;
        try{
          if(!localPlayerId){
            const payload = { name: username, lastSeen: new Date().toISOString(), online:true, nameColor, avatarUrl: avatarDataUrl };
            const res = await safeFetch(PLAYERS_API, 'POST', payload);
            if(res.ok){
              const data = await res.json();
              localPlayerId = data.id;
              localStorage.setItem('notcord_playerId', localPlayerId);
            }
          } else {
            await safeFetch(`${PLAYERS_API}/${localPlayerId}`, 'PUT', { name: username, lastSeen: new Date().toISOString(), online:true, nameColor, avatarUrl: avatarDataUrl });
          }
        }catch(e){ console.error(e); }
      }

      async function setLocalPlayerOnlineState(onlineState){
        if(!localPlayerId) return;
        try{
          await safeFetch(`${PLAYERS_API}/${localPlayerId}`, 'PUT', { lastSeen: new Date().toISOString(), online:onlineState, name: username, nameColor, avatarUrl: avatarDataUrl });
        }catch(e){ console.error(e); }
      }

      function startHeartbeat(){
        if(heartbeatInterval) clearInterval(heartbeatInterval);
        heartbeatInterval = setInterval(async ()=>{
          if(username && localPlayerId){
            try{
              await safeFetch(`${PLAYERS_API}/${localPlayerId}`, 'PUT', { lastSeen: new Date().toISOString(), online:true, name: username, nameColor, avatarUrl: avatarDataUrl });
            }catch(e){}
          }
        }, HEARTBEAT_MS);
      }

      function stopHeartbeat(){
        if(heartbeatInterval){ clearInterval(heartbeatInterval); heartbeatInterval = null; }
      }

      // --- Messages ---
      async function fetchMessages(){
        if(!apiBase) return;
        try{
          const res = await fetch(apiBase);
          if(!res.ok) throw new Error('fetch failed');
          let data = await res.json();
          if(!Array.isArray(data)) data = [];
          const sorted = data.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
          if(sorted.length > MAX_MESSAGES_KEEP){
            const toDelete = sorted.slice(0, TRIM_DELETE_COUNT);
            for(const m of toDelete){
              try{ await fetch(`${apiBase}/${m.id}`, {method:'DELETE'}); }catch(e){}
            }
            await fetchMessages();
            return;
          }
          renderMessages(sorted);
        }catch(e){ console.error(e); setStatus('Error loading messages'); }
      }

      function renderAvatarToEl(avatarUrl, el){
        el.innerHTML = '';
        if(avatarUrl){
          const img = document.createElement('img');
          img.src = avatarUrl;
          img.style.width='100%';
          img.style.height='100%';
          img.style.objectFit='cover';
          el.appendChild(img);
        }
      }

      function renderMessages(msgs){
        messagesEl.innerHTML = '';
        for(const m of msgs){
          if(!m || isUserMuted(m.username)) continue;
          const div = document.createElement('div');
          div.className = 'message';
          div.dataset.id = m.id;
          if(m.username === username) div.classList.add('me');

          const bubble = document.createElement('div');
          bubble.className = 'bubble';

          const metaDiv = document.createElement('div');
          metaDiv.className = 'meta';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'name';
          nameSpan.textContent = m.username || 'Anon';
          if(m.nameColor) nameSpan.style.color = m.nameColor;

          const timeSpan = document.createElement('span');
          timeSpan.className = 'time';
          timeSpan.textContent = formatTime(m.createdAt);

          metaDiv.appendChild(nameSpan);
          metaDiv.appendChild(timeSpan);

          if(activeChannel === 'photos' && m.imageUrl){
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photoMessage';
            const img = document.createElement('img');
            img.src = m.imageUrl;
            img.alt = 'User photo';
            img.onclick = ()=> window.open(m.imageUrl, '_blank');
            photoDiv.appendChild(img);
            bubble.appendChild(metaDiv);
            bubble.appendChild(photoDiv);
          } else if(activeChannel === 'code' && m.code){
            const codeDiv = document.createElement('div');
            codeDiv.className = 'code-block';
            
            if(m.language){
              const langTag = document.createElement('div');
              langTag.className = 'language-tag';
              langTag.textContent = m.language.toUpperCase();
              codeDiv.appendChild(langTag);
            }
            
            const codeText = document.createElement('div');
            codeText.textContent = m.code;
            codeText.style.marginTop = '0';
            codeDiv.appendChild(codeText);
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = ()=>{
              navigator.clipboard.writeText(m.code).then(()=>{
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.add('copied');
                setTimeout(()=>{ copyBtn.textContent = 'Copy'; copyBtn.classList.remove('copied'); }, 2000);
              }).catch(()=>{
                copyBtn.textContent = 'Failed';
                setTimeout(()=>{ copyBtn.textContent = 'Copy'; }, 2000);
              });
            };
            codeDiv.appendChild(copyBtn);
            
            bubble.appendChild(metaDiv);
            bubble.appendChild(codeDiv);
          } else {
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            let msgText = m.message || '';
            const mentionRegex = /@(\w{1,8})/g;
            let parts = [];
            let lastIndex = 0;
            let match;
            while((match = mentionRegex.exec(msgText)) !== null){
              if(match.index > lastIndex){
                parts.push(document.createTextNode(msgText.slice(lastIndex, match.index)));
              }
              const mentionSpan = document.createElement('span');
              mentionSpan.className = 'mention';
              mentionSpan.textContent = match[0];
              parts.push(mentionSpan);
              if(match[1].toLowerCase() === username.toLowerCase() && m.id && !notifiedSet.has(m.id)){
                if('Notification' in window && Notification.permission === 'granted'){
                  try{ new Notification('notcord mention', { body: `${m.username} mentioned you: ${msgText.slice(0,60)}...` }); }catch(e){}
                }
                notifiedSet.add(m.id);
                const arr = Array.from(notifiedSet).slice(-200);
                localStorage.setItem(notifiedKey, JSON.stringify(arr));
              }
              lastIndex = match.index + match[0].length;
            }
            if(lastIndex < msgText.length){
              parts.push(document.createTextNode(msgText.slice(lastIndex)));
            }
            for(const p of parts) textDiv.appendChild(p);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'actions';
            const pinBtn = document.createElement('button');
            pinBtn.textContent = 'üìå';
            pinBtn.title = 'Pin (local)';
            pinBtn.onclick = ()=>{
              if(pinned.find(x=>x.id===m.id)){ setStatus('Already pinned'); return; }
              pinned.push({ id: m.id, username: m.username, message: m.message, createdAt: m.createdAt });
              savePinned();
              setStatus('Pinned');
            };
            const replyBtn = document.createElement('button');
            replyBtn.textContent = '‚Ü©Ô∏è';
            replyBtn.title = 'Reply';
            replyBtn.onclick = ()=>{
              if(m.username){
                messageInput.value = '@' + m.username + ' ';
                messageInput.focus();
                setStatus('Replying to ' + m.username);
              }
            };
            actionsDiv.appendChild(pinBtn);
            actionsDiv.appendChild(replyBtn);

            bubble.appendChild(metaDiv);
            bubble.appendChild(textDiv);
            bubble.appendChild(actionsDiv);
          }

          if(m.avatarUrl){
            const avatarEl = document.createElement('div');
            avatarEl.style.width='36px';
            avatarEl.style.height='36px';
            avatarEl.style.borderRadius='50%';
            avatarEl.style.overflow='hidden';
            avatarEl.style.background='rgba(255,255,255,0.03)';
            avatarEl.style.flexShrink='0';
            const img = document.createElement('img');
            img.src = m.avatarUrl;
            img.style.width='100%';
            img.style.height='100%';
            img.style.objectFit='cover';
            avatarEl.appendChild(img);
            div.appendChild(avatarEl);
          }

          div.appendChild(bubble);
          messagesEl.appendChild(div);
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function postMessage(text){
        if(!text || !text.trim()) return;
        if(!username){ setStatus('Set username first'); return; }
        if(isUserMuted(username)){ setStatus('You are muted.'); return; }
        if(containsBadWords(text)){
          muteUser(username, 120);
          setStatus('Forbidden word detected. You are muted for 2 minutes.');
          return;
        }
        isSending = true;
        try{
          const payload = { username, message: text, createdAt: new Date().toISOString(), nameColor, avatarUrl: avatarDataUrl || null };
          const res = await fetch(apiBase, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('post failed');
          await fetchMessages();
        }catch(e){
          console.error(e);
          setStatus('Failed to send');
        }finally{
          isSending = false;
        }
      }

      async function uploadCode(){
        const code = codeInput.value;
        if(!code || !code.trim()){ setStatus('Enter some code first'); return; }
        if(!username){ setStatus('Set username first'); return; }
        if(isUserMuted(username)){ setStatus('You are muted'); return; }
        if(containsBadWords(code)){
          muteUser(username, 120);
          setStatus('Forbidden word detected. You are muted for 2 minutes.');
          return;
        }
        isSending = true;
        try{
          const language = languageInput.value.trim() || 'text';
          const payload = { username, code, language, createdAt: new Date().toISOString(), nameColor, avatarUrl: avatarDataUrl || null };
          const res = await fetch(CHANNELS.code, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('upload failed');
          setStatus('Code uploaded');
          codeInput.value = '';
          languageInput.value = '';
          await fetchMessages();
        }catch(e){
          console.error(e);
          setStatus('Code upload failed');
        }finally{
          isSending = false;
        }
      }

      // UI event listeners
      Array.from(channelsEl.children).forEach(ch => {
        ch.addEventListener('click', async ()=>{
          const id = ch.dataset.id;
          if(!id || id === activeChannel) return;
          await setActiveChannel(id);
        });
      });

      setNameBtn.addEventListener('click', async ()=>{
        const u = usernameInput.value.trim();
        if(!u){ setStatus('Enter username'); return; }
        if(u.length > 8){ setStatus('Username max 8 chars'); return; }
        if(containsBadWords(u)){ setStatus('Forbidden name'); return; }
        username = u;
        const now = Date.now();
        lastNameChange = now;
        localStorage.setItem('notcord_lastNameChange', String(lastNameChange));
        localStorage.setItem('notcord_username', username);
        usernameBox.style.display = 'none'; usernameLocked.style.display = 'flex'; usernameDisplay.textContent = username;
        nameMeta.textContent = avatarDataUrl ? 'Avatar set' : 'No avatar';
        renderAvatarToEl(avatarDataUrl, avatarDisplay);
        await upsertLocalPlayer(); await setLocalPlayerOnlineState(true); startHeartbeat(); await fetchPlayers(); updateCharCountAndState();
      });

      changeNameBtn.addEventListener('click', ()=>{
        const now = Date.now();
        if(now - lastNameChange < WEEK_MS){
          const hours = Math.ceil((WEEK_MS - (now - lastNameChange))/3600000);
          setStatus('Name can be changed in '+hours+'h');
          return;
        }
        usernameInput.value = username || '';
        usernameBox.style.display = 'flex'; usernameLocked.style.display = 'none';
      });

      avatarInput.addEventListener('change', async (e)=>{
        const file = avatarInput.files[0];
        if(!file) return;
        const now = Date.now();
        if(now - lastAvatarChange < WEEK_MS){
          const hrs = Math.ceil((WEEK_MS - (now - lastAvatarChange))/3600000);
          setStatus('Avatar can be changed in '+hrs+'h');
          avatarInput.value = '';
          return;
        }
        try{
          const r = await resizeImageFile(file, 256, 256);
          if(!r.ok) throw new Error('avatar resize failed');
          avatarDataUrl = r.dataUrl;
          localStorage.setItem('notcord_avatar', avatarDataUrl);
          lastAvatarChange = now;
          localStorage.setItem('notcord_lastAvatarChange', String(lastAvatarChange));
          renderAvatarToEl(avatarDataUrl, avatarDisplay);
          nameMeta.textContent = 'Avatar set';
          setStatus('Avatar updated');
          if(localPlayerId) await safeFetch(`${PLAYERS_API}/${localPlayerId}`, 'PUT', { avatarUrl: avatarDataUrl, name: username, lastSeen: new Date().toISOString(), nameColor });
          await fetchPlayers();
        }catch(err){ console.error(err); setStatus('Avatar upload failed'); }
        finally{ avatarInput.value = ''; }
      });

      changeAvatarBtn.addEventListener('click', ()=> avatarInput.click());

      sendBtn.addEventListener('click', ()=>{
        const txt = messageInput.value;
        postMessage(txt);
        messageInput.value = ''; updateCharCountAndState();
        const map = readTypingMap(); if(map[activeChannel] && map[activeChannel][username]){ delete map[activeChannel][username]; writeTypingMap(map); updateTypingUI(); }
      });

      messageInput.addEventListener('input', ()=>{
        updateCharCountAndState();
        if(username){
          const map = readTypingMap(); map[activeChannel] = map[activeChannel] || {}; map[activeChannel][username] = Date.now(); writeTypingMap(map); updateTypingUI();
        }
      });

      messageInput.addEventListener('keydown', (e)=>{ 
        if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(!sendBtn.disabled) sendBtn.click(); }
        if(e.key === 'Escape'){ if(replyToMessage) clearReplyTo(); messageInput.blur(); }
      });

      photoInput.addEventListener('change', ()=> uploadPhotoBtn.disabled = !photoInput.files.length );
      uploadPhotoBtn.addEventListener('click', ()=> { if(photoInput.files.length) uploadPhoto(photoInput.files[0]); });
      
      uploadCodeBtn.addEventListener('click', uploadCode);

      nameColorInput.addEventListener('input', async (e)=>{ nameColor = e.target.value; localStorage.setItem('notcord_nameColor', nameColor); if(localPlayerId) await safeFetch(`${PLAYERS_API}/${localPlayerId}`, 'PUT', { name: username, lastSeen: new Date().toISOString(), nameColor, avatarUrl: avatarDataUrl }); fetchPlayers().catch(()=>{}); });
      resetNameColorBtn.addEventListener('click', ()=>{ nameColor='#ffcc00'; nameColorInput.value = nameColor; localStorage.setItem('notcord_nameColor', nameColor); });

      themeColor1Input.addEventListener('input', (e)=>{ themeColor1 = e.target.value; localStorage.setItem('notcord_theme1', themeColor1); applyTheme(); });
      resetTheme1Btn.addEventListener('click', ()=>{ themeColor1='#0b2b26'; themeColor1Input.value = themeColor1; localStorage.setItem('notcord_theme1', themeColor1); applyTheme(); });

      themeColor2Input.addEventListener('input', (e)=>{ themeColor2 = e.target.value; localStorage.setItem('notcord_theme2', themeColor2); applyTheme(); });
      resetTheme2Btn.addEventListener('click', ()=>{ themeColor2='#071a16'; themeColor2Input.value = themeColor2; localStorage.setItem('notcord_theme2', themeColor2); applyTheme(); });

      themeColor3Input.addEventListener('input', (e)=>{ themeColor3 = e.target.value; localStorage.setItem('notcord_theme3', themeColor3); applyTheme(); });
      resetTheme3Btn.addEventListener('click', ()=>{ themeColor3='#1e3d38'; themeColor3Input.value = themeColor3; localStorage.setItem('notcord_theme3', themeColor3); applyTheme(); });

      accentColorInput.addEventListener('input', (e)=>{ accentColor = e.target.value; localStorage.setItem('notcord_accent', accentColor); applyTheme(); });
      resetAccentBtn.addEventListener('click', ()=>{ accentColor='#c62828'; accentColorInput.value = accentColor; localStorage.setItem('notcord_accent', accentColor); applyTheme(); });

      particlesToggleBtn.addEventListener('click', toggleParticles);

      // Switch channel
      async function setActiveChannel(id){
        activeChannel = id; apiBase = CHANNELS[id] || null; localStorage.setItem('notcord_channel', id);
        Array.from(channelsEl.children).forEach(ch => ch.classList.toggle('active', ch.dataset.id === id));
        channelTitleEl.textContent = '# ' + id;
        updateInputArea();
        if(polling) clearInterval(polling);
        await fetchMessages();
        if(id !== 'photos' && id !== 'code') polling = setInterval(fetchMessages, 2000);
      }

      function updateCharCountAndState(){
        let val = messageInput.value || '';
        if(val.length > MAX_CHARS) messageInput.value = val.slice(0, MAX_CHARS);
        charCountEl.textContent = `${(messageInput.value||'').length} / ${MAX_CHARS}`;
        const canSend = username && (messageInput.value||'').trim().length > 0 && activeChannel !== 'photos' && activeChannel !== 'code' && !isSending && !isUserMuted(username);
        sendBtn.disabled = !canSend;
      }

      function updateInputArea(){
        if(activeChannel === 'photos'){
          inputWrapper.style.display = 'none';
          photoUploadWrapper.style.display = 'flex';
          codeUploadWrapper.style.display = 'none';
          uploadPhotoBtn.disabled = true;
        } else if (activeChannel === 'code') {
          inputWrapper.style.display = 'none';
          photoUploadWrapper.style.display = 'none';
          codeUploadWrapper.style.display = 'block';
        } else {
          photoUploadWrapper.style.display = 'none';
          codeUploadWrapper.style.display = 'none';
          inputWrapper.style.display = 'flex';
        }
      }

      // Image resizing function
      function resizeImageFile(file, maxWidth=1200, maxHeight=1200){
        return new Promise((resolve, reject)=>{
          if(!file.type || file.type === 'image/gif'){
            const reader = new FileReader();
            reader.onload = (e)=> resolve({ ok:true, dataUrl: e.target.result });
            reader.onerror = reject;
            reader.readAsDataURL(file);
            return;
          }
          const reader = new FileReader();
          reader.onload = (e)=>{
            const img = new Image();
            img.onload = ()=>{
              let w = img.width, h = img.height;
              const sizeKB = file.size / 1024;
              let factor = 1;
              if(sizeKB > 1500) factor = 0.55;
              else if(sizeKB > 900) factor = 0.75;
              else if(sizeKB > 400) factor = 0.9;
              const targetW = Math.round(maxWidth * factor);
              const targetH = Math.round(maxHeight * factor);
              const ratio = Math.min(targetW / w, targetH / h, 1);
              w = Math.round(w * ratio); h = Math.round(h * ratio);
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img,0,0,w,h);
              const quality = (sizeKB > 1200) ? 0.75 : 0.85;
              const dataUrl = canvas.toDataURL('image/jpeg', quality);
              resolve({ ok:true, dataUrl });
            };
            img.onerror = (err)=> reject(err);
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Upload photo
      async function uploadPhoto(file){
        if(!file) return;
        if(!username){ setStatus('Set username first'); return; }
        if(isUserMuted(username)){ setStatus('You are muted and cannot upload'); return; }
        if(containsBadWords(file.name)){ muteUser(username, 120); setStatus('Forbidden file name. You are muted for 2 minutes.'); return; }
        isSending = true; uploadPhotoBtn.disabled = true;
        try{
          let r = await resizeImageFile(file, 1200, 1200);
          if(!r.ok) throw new Error('Resize failed');
          let dataUrl = r.dataUrl;
          const approxSize = Math.round((dataUrl.length - dataUrl.indexOf(',') - 1) * 3/4);
          if(approxSize > 1500*1024 && file.type !== 'image/gif'){
            const r2 = await resizeImageFile(file, 800, 800);
            if(r2.ok) dataUrl = r2.dataUrl;
          }
          const payload = { username, createdAt: new Date().toISOString(), nameColor, imageUrl: dataUrl, message: '' , avatarUrl: avatarDataUrl || null};
          const res = await fetch(CHANNELS.photos, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if(!res.ok) throw new Error('Upload failed: '+res.status);
          setStatus('Photo uploaded');
          photoInput.value = '';
          await fetchMessages();
        }catch(e){
          console.error(e);
          setStatus('Photo upload failed');
        }finally{
          isSending = false; uploadPhotoBtn.disabled = false;
        }
      }

      // cleanup typing
      function cleanupTypingMap(){
        const map = readTypingMap(); const now = Date.now(); let changed = false;
        for(const ch of Object.keys(map)){ for(const u of Object.keys(map[ch])){ if(now - map[ch][u] > TYPING_EXPIRE_MS){ delete map[ch][u]; changed = true; } } if(Object.keys(map[ch]).length===0) delete map[ch]; }
        if(changed) writeTypingMap(map);
        updateTypingUI();
      }

      // Initial load
      async function init(){
        createSnowflakes();
        applyTheme(); initializeAppearanceInputs();
        if(avatarDataUrl) renderAvatarToEl(avatarDataUrl, avatarDisplay);
        if(username){ usernameBox.style.display='none'; usernameLocked.style.display='flex'; usernameDisplay.textContent = username; nameMeta.textContent = avatarDataUrl? 'Avatar set' : 'No avatar'; await upsertLocalPlayer(); await setLocalPlayerOnlineState(true); startHeartbeat(); } else { usernameBox.style.display='flex'; usernameLocked.style.display='none'; }
        await fetchPublicPinned();
        startPinRotation(7000);
        await setActiveChannel(activeChannel);
        await fetchPlayers();
        if(playersPolling) clearInterval(playersPolling);
        playersPolling = setInterval(fetchPlayers, 5000);
        setInterval(cleanupTypingMap, 2000);
        setInterval(fetchPublicPinned, 15000);
        setStatus('Connected (Christmas Edition)');
        renderPinnedLocal();
      }
      init();

      // visibility handling
      document.addEventListener('visibilitychange', async ()=>{
        if(!username) return;
        if(document.hidden){
          try{
            if(localPlayerId && navigator.sendBeacon){
              const url = `${PLAYERS_API}/${localPlayerId}`;
              const payload = JSON.stringify({ lastSeen: new Date().toISOString(), online:false, name: username, nameColor, avatarUrl: avatarDataUrl });
              const blob = new Blob([payload], { type: 'application/json' });
              navigator.sendBeacon(url, blob);
            } else {
              await setLocalPlayerOnlineState(false);
            }
          }catch(e){}
          stopHeartbeat();
        } else {
          await upsertLocalPlayer();
          startHeartbeat();
        }
      });

      window.addEventListener('beforeunload', ()=>{
        try{
          if(localPlayerId){
            const url = `${PLAYERS_API}/${localPlayerId}`;
            const payload = JSON.stringify({ lastSeen: new Date().toISOString(), online:false, name: username, nameColor, avatarUrl: avatarDataUrl });
            if(navigator.sendBeacon){
              const blob = new Blob([payload], { type: 'application/json' });
              navigator.sendBeacon(url, blob);
            } else {
              fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: payload }).catch(()=>{});
            }
          }
        }catch(e){}
      });

      // Expose debug
      window._notcord = { fetchMessages, fetchPlayers, pinned, fetchPublicPinned, publicPinnedList, startPinRotation };

    })();
  </script>
</body>
</html>
